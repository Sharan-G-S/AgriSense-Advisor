"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1401],{77948:function(e,t,n){n.d(t,{I6:function(){return isLiveNode},Pz:function(){return stringify},VB:function(){return ee},WO:function(){return removeReaction},W_:function(){return N},Wy:function(){return applyOptimisticUpdates},Xd:function(){return shallow},YF:function(){return deleteComment},Zb:function(){return makeEventSource},Ze:function(){return V},eI:function(){return createClient},iV:function(){return h},iz:function(){return Q},l8:function(){return detectDupes},nn:function(){return nn},rU:function(){return addReaction},sE:function(){return upsertComment},x3:function(){return makePoller},yO:function(){return S}});var i,o,r,s,a,d=Object.defineProperty,c="@liveblocks/core",l="1.11.1",u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function error(e){console.error(e)}function detectDupes(e,t,n){let i=Symbol.for(e),o=n?`${t||"dev"} (${n})`:t||"dev";if(u[i]){if(u[i]===o);else{let t=`Multiple copies of Liveblocks are being loaded in your project. This will cause issues! See https://liveblocks.io/docs/errors/dupes 

Conflicts:
- ${e} ${u[i]} (already loaded)
- ${e} ${o} (trying to load this now)`;error(t)}}else u[i]=o;t&&l&&t!==l&&error(`Cross-linked versions of Liveblocks found, which will cause issues! See https://liveblocks.io/docs/errors/cross-linked 

Conflicts:
- ${c} is at ${l}
- ${e} is at ${t}

Always upgrade all Liveblocks packages to the same version number.`)}function assertNever(e,t){throw Error(t)}function nn(e,t="Expected value to be non-nullable"){return e}function controlledPromise(){let e;let t=new Promise(t=>{e=t});if(!e)throw Error("Should never happen");return[t,e]}function makeEventSource(){let e=new Set,t=new Set,n=null;function subscribe(e){return t.add(e),()=>t.delete(e)}function subscribeOnce(t){return e.add(t),()=>e.delete(t)}async function waitUntil(e){let t;return new Promise(n=>{t=subscribe(t=>{(void 0===e||e(t))&&n(t)})}).finally(()=>t?.())}function notify(n){e.forEach(e=>e(n)),e.clear(),t.forEach(e=>e(n))}return{notify:function(e){null!==n?n.push(e):notify(e)},subscribe,subscribeOnce,clear:function(){e.clear(),t.clear()},count:function(){return e.size+t.size},waitUntil,pause:function(){n=[]},unpause:function(){if(null!==n){for(let e of n)notify(e);n=null}},observable:{subscribe,subscribeOnce,waitUntil}}}var h={};((e,t)=>{for(var n in t)d(e,n,{get:t[n],enumerable:!0})})(h,{error:()=>m,errorWithTitle:()=>y,warn:()=>f,warnWithTitle:()=>_});var p="background:#0e0d12;border-radius:9999px;color:#fff;padding:3px 7px;font-family:sans-serif;font-weight:600;";function wrap(e){return"undefined"==typeof window?console[e]:(t,...n)=>console[e]("%cLiveblocks",p,t,...n)}var f=wrap("warn"),m=wrap("error");function wrapWithTitle(e){return"undefined"==typeof window?console[e]:(t,n,...i)=>console[e](`%cLiveblocks%c ${t}`,p,"font-weight:600",n,...i)}var _=wrapWithTitle("warn"),y=wrapWithTitle("error");function distance(e,t){if(e===t)return[0,0];let n=e.split("."),i=t.split("."),o=Math.min(n.length,i.length),r=0;for(;r<o&&n[r]===i[r];r++);let s=n.length-r,a=i.length-r;return[s,a]}function patterns(e,t){let n=e.split(".");if(t<1||t>n.length+1)throw Error("Invalid number of levels");let i=[];t>n.length&&i.push("*");for(let e=n.length-t+1;e<n.length;e++){let t=n.slice(0,e);t.length>0&&i.push(t.join(".")+".*")}return i.push(e),i}var g=class{constructor(e){this.curr=e}get current(){return this.curr}allowPatching(e){let t=this,n=!0,i={...this.curr,patch(e){if(n)for(let n of(t.curr=Object.assign({},t.curr,e),Object.entries(e))){let[e,t]=n;"patch"!==e&&(this[e]=t)}else throw Error("Can no longer patch stale context")}};e(i),n=!1}},v=1,b=class{get initialState(){let e=this.states.values()[Symbol.iterator]().next();if(!e.done)return e.value;throw Error("No states defined yet")}get currentState(){if(null===this.currentStateOrNull){if(0===this.runningState)throw Error("Not started yet");throw Error("Already stopped")}return this.currentStateOrNull}start(){if(0!==this.runningState)throw Error("State machine has already started");return this.runningState=1,this.currentStateOrNull=this.initialState,this.enter(null),this}stop(){if(1!==this.runningState)throw Error("Cannot stop a state machine that hasn't started yet");this.exit(null),this.runningState=2,this.currentStateOrNull=null}constructor(e){this.id=v++,this.runningState=0,this.currentStateOrNull=null,this.states=new Set,this.enterFns=new Map,this.cleanupStack=[],this.knownEventTypes=new Set,this.allowedTransitions=new Map,this.currentContext=new g(e),this.eventHub={didReceiveEvent:makeEventSource(),willTransition:makeEventSource(),didIgnoreEvent:makeEventSource(),willExitState:makeEventSource(),didEnterState:makeEventSource()},this.events={didReceiveEvent:this.eventHub.didReceiveEvent.observable,willTransition:this.eventHub.willTransition.observable,didIgnoreEvent:this.eventHub.didIgnoreEvent.observable,willExitState:this.eventHub.willExitState.observable,didEnterState:this.eventHub.didEnterState.observable}}get context(){return this.currentContext.current}addState(e){if(0!==this.runningState)throw Error("Already started");return this.states.add(e),this}onEnter(e,t){if(0!==this.runningState)throw Error("Already started");if(this.enterFns.has(e))throw Error(`enter/exit function for ${e} already exists`);return this.enterFns.set(e,t),this}onEnterAsync(e,t,n,i){return this.onEnter(e,()=>{let e=new AbortController,o=e.signal,r=!1;return t(this.currentContext.current,o).then(e=>{o.aborted||(r=!0,this.transition({type:"ASYNC_OK",data:e},n))},e=>{o.aborted||(r=!0,this.transition({type:"ASYNC_ERROR",reason:e},i))}),()=>{r||e.abort()}})}getStatesMatching(e){let t=[];if("*"===e)for(let e of this.states)t.push(e);else if(e.endsWith(".*")){let n=e.slice(0,-1);for(let e of this.states)e.startsWith(n)&&t.push(e)}else this.states.has(e)&&t.push(e);if(0===t.length)throw Error(`No states match ${JSON.stringify(e)}`);return t}addTransitions(e,t){if(0!==this.runningState)throw Error("Already started");for(let n of this.getStatesMatching(e)){let i=this.allowedTransitions.get(n);for(let[o,r]of(void 0===i&&(i=new Map,this.allowedTransitions.set(n,i)),Object.entries(t))){if(i.has(o))throw Error(`Trying to set transition "${o}" on "${n}" (via "${e}"), but a transition already exists there.`);let t=r;if(this.knownEventTypes.add(o),void 0!==t){let e="function"==typeof t?t:()=>t;i.set(o,e)}}}return this}addTimedTransition(e,t,n){return this.onEnter(e,()=>{let e="function"==typeof t?t(this.currentContext.current):t,i=setTimeout(()=>{this.transition({type:"TIMER"},n)},e);return()=>{clearTimeout(i)}})}getTargetFn(e){return this.allowedTransitions.get(this.currentState)?.get(e)}exit(e){this.eventHub.willExitState.notify(this.currentState),this.currentContext.allowPatching(t=>{e=e??this.cleanupStack.length;for(let n=0;n<e;n++)this.cleanupStack.pop()?.(t)})}enter(e){let t=patterns(this.currentState,e??this.currentState.split(".").length+1);this.currentContext.allowPatching(e=>{for(let n of t){let t=this.enterFns.get(n),i=t?.(e);"function"==typeof i?this.cleanupStack.push(i):this.cleanupStack.push(null)}}),this.eventHub.didEnterState.notify(this.currentState)}send(e){if(!this.knownEventTypes.has(e.type))throw Error(`Invalid event ${JSON.stringify(e.type)}`);if(2===this.runningState)return;let t=this.getTargetFn(e.type);if(void 0!==t)return this.transition(e,t);this.eventHub.didIgnoreEvent.notify(e)}transition(e,t){let n,i;this.eventHub.didReceiveEvent.notify(e);let o=this.currentState,r=("function"==typeof t?t:()=>t)(e,this.currentContext.current);if(null===r){this.eventHub.didIgnoreEvent.notify(e);return}if("string"==typeof r?n=r:(n=r.target,i=Array.isArray(r.effect)?r.effect:[r.effect]),!this.states.has(n))throw Error(`Invalid next state name: ${JSON.stringify(n)}`);this.eventHub.willTransition.notify({from:o,to:n});let[s,a]=distance(this.currentState,n);if(s>0&&this.exit(s),this.currentStateOrNull=n,void 0!==i){let t=i;this.currentContext.allowPatching(n=>{for(let i of t)"function"==typeof i?i(n,e):n.patch(i)})}a>0&&this.enter(a)}};function isPlainObject(e){return null!==e&&"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)}function entries(e){return Object.entries(e)}function tryParseJson(e){try{return JSON.parse(e)}catch(e){return}}function deepClone(e){return JSON.parse(JSON.stringify(e))}function b64decode(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""));return n}catch(t){return atob(e)}}function compact(e){return e.filter(e=>null!=e)}function compactObject(e){let t={...e};return Object.keys(e).forEach(e=>{void 0===t[e]&&delete t[e]}),t}async function withTimeout(e,t,n){let i;let o=new Promise((e,o)=>{i=setTimeout(()=>{o(Error(n))},t)});return Promise.race([e,o]).finally(()=>clearTimeout(i))}var S=((i=S||{})[i.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",i[i.USER_JOINED=101]="USER_JOINED",i[i.USER_LEFT=102]="USER_LEFT",i[i.BROADCASTED_EVENT=103]="BROADCASTED_EVENT",i[i.ROOM_STATE=104]="ROOM_STATE",i[i.INITIAL_STORAGE_STATE=200]="INITIAL_STORAGE_STATE",i[i.UPDATE_STORAGE=201]="UPDATE_STORAGE",i[i.REJECT_STORAGE_OP=299]="REJECT_STORAGE_OP",i[i.UPDATE_YDOC=300]="UPDATE_YDOC",i[i.THREAD_CREATED=400]="THREAD_CREATED",i[i.THREAD_METADATA_UPDATED=401]="THREAD_METADATA_UPDATED",i[i.COMMENT_CREATED=402]="COMMENT_CREATED",i[i.COMMENT_EDITED=403]="COMMENT_EDITED",i[i.COMMENT_DELETED=404]="COMMENT_DELETED",i[i.COMMENT_REACTION_ADDED=405]="COMMENT_REACTION_ADDED",i[i.COMMENT_REACTION_REMOVED=406]="COMMENT_REACTION_REMOVED",i),E=((o=E||{})[o.CLOSE_NORMAL=1e3]="CLOSE_NORMAL",o[o.CLOSE_ABNORMAL=1006]="CLOSE_ABNORMAL",o[o.UNEXPECTED_CONDITION=1011]="UNEXPECTED_CONDITION",o[o.TRY_AGAIN_LATER=1013]="TRY_AGAIN_LATER",o[o.INVALID_MESSAGE_FORMAT=4e3]="INVALID_MESSAGE_FORMAT",o[o.NOT_ALLOWED=4001]="NOT_ALLOWED",o[o.MAX_NUMBER_OF_MESSAGES_PER_SECONDS=4002]="MAX_NUMBER_OF_MESSAGES_PER_SECONDS",o[o.MAX_NUMBER_OF_CONCURRENT_CONNECTIONS=4003]="MAX_NUMBER_OF_CONCURRENT_CONNECTIONS",o[o.MAX_NUMBER_OF_MESSAGES_PER_DAY_PER_APP=4004]="MAX_NUMBER_OF_MESSAGES_PER_DAY_PER_APP",o[o.MAX_NUMBER_OF_CONCURRENT_CONNECTIONS_PER_ROOM=4005]="MAX_NUMBER_OF_CONCURRENT_CONNECTIONS_PER_ROOM",o[o.ROOM_ID_UPDATED=4006]="ROOM_ID_UPDATED",o[o.KICKED=4100]="KICKED",o[o.TOKEN_EXPIRED=4109]="TOKEN_EXPIRED",o[o.CLOSE_WITHOUT_RETRY=4999]="CLOSE_WITHOUT_RETRY",o);function shouldDisconnect(e){return 4999===e||e>=4e3&&e<4100}function shouldReauth(e){return e>=4100&&e<4200}function shouldRetryWithoutReauth(e){return 1013===e||e>=4200&&e<4300}function isIdle(e){return"initial"===e||"disconnected"===e}function newToLegacyStatus(e){switch(e){case"connecting":return"connecting";case"connected":return"open";case"reconnecting":return"unavailable";case"disconnected":return"failed";default:return"closed"}}function toNewConnectionStatus(e){let t=e.currentState;switch(t){case"@ok.connected":case"@ok.awaiting-pong":return"connected";case"@idle.initial":return"initial";case"@auth.busy":case"@auth.backoff":case"@connecting.busy":case"@connecting.backoff":case"@idle.zombie":return e.context.successCount>0?"reconnecting":"connecting";case"@idle.failed":return"disconnected";default:return assertNever(t,"Unknown state")}}var T=[250,500,1e3,2e3,4e3,8e3,1e4],k=T[0]-1,w=[2e3,3e4,6e4,3e5],O=class extends Error{constructor(e){super(e)}},A=class extends Error{constructor(e,t){super(e),this.code=t}};function nextBackoffDelay(e,t){return t.find(t=>t>e)??t[t.length-1]}function increaseBackoffDelay(e){e.patch({backoffDelay:nextBackoffDelay(e.backoffDelay,T)})}function increaseBackoffDelayAggressively(e){e.patch({backoffDelay:nextBackoffDelay(e.backoffDelay,w)})}function resetSuccessCount(e){e.patch({successCount:0})}function log(e,t){let n=2===e?m:1===e?f:()=>{};return()=>{n(t)}}function logPrematureErrorOrCloseEvent(e){let t="Connection to Liveblocks websocket server";return n=>{e instanceof Error?f(`${t} could not be established. ${String(e)}`):f(isCloseEvent(e)?`${t} closed prematurely (code: ${e.code}). Retrying in ${n.backoffDelay}ms.`:`${t} could not be established.`)}}function logCloseEvent(e){let t=[`code: ${e.code}`];return e.reason&&t.push(`reason: ${e.reason}`),e=>{f(`Connection to Liveblocks websocket server closed (${t.join(", ")}). Retrying in ${e.backoffDelay}ms.`)}}var I=log(1,"Connection to WebSocket closed permanently. Won't retry.");function isCloseEvent(e){return!(e instanceof Error)&&"close"===e.type}function enableTracing(e){let t=new Date().getTime();function log2(...n){f(`${((new Date().getTime()-t)/1e3).toFixed(2)} [FSM #${e.id}]`,...n)}let n=[e.events.didReceiveEvent.subscribe(e=>log2(`Event ${e.type}`)),e.events.willTransition.subscribe(({from:e,to:t})=>log2("Transitioning",e,"→",t)),e.events.didIgnoreEvent.subscribe(e=>log2("Ignored event",e.type,e,"(current state won't handle it)"))];return()=>{for(let e of n)e()}}function defineConnectivityEvents(e){let t=makeEventSource(),n=makeEventSource(),i=makeEventSource(),o=null,r=e.events.didEnterState.subscribe(()=>{let r=toNewConnectionStatus(e);r!==o&&t.notify(r),"connected"===o&&"connected"!==r?i.notify():"connected"!==o&&"connected"===r&&n.notify(),o=r});return{statusDidChange:t.observable,didConnect:n.observable,didDisconnect:i.observable,unsubscribe:r}}var assign=e=>t=>t.patch(e);function createConnectionStateMachine(e,t){let n=makeEventSource();n.pause();let i=makeEventSource();function fireErrorEvent(e,t){return()=>{let n=new A(e,t);i.notify(n)}}let o=new b({successCount:0,authValue:null,socket:null,backoffDelay:k}).addState("@idle.initial").addState("@idle.failed").addState("@idle.zombie").addState("@auth.busy").addState("@auth.backoff").addState("@connecting.busy").addState("@connecting.backoff").addState("@ok.connected").addState("@ok.awaiting-pong");o.addTransitions("*",{RECONNECT:{target:"@auth.backoff",effect:[increaseBackoffDelay,resetSuccessCount]},DISCONNECT:"@idle.initial"}),o.onEnter("@idle.*",resetSuccessCount).addTransitions("@idle.*",{CONNECT:(e,t)=>null!==t.authValue?"@connecting.busy":"@auth.busy"}),o.addTransitions("@auth.backoff",{NAVIGATOR_ONLINE:{target:"@auth.busy",effect:assign({backoffDelay:k})}}).addTimedTransition("@auth.backoff",e=>e.backoffDelay,"@auth.busy").onEnterAsync("@auth.busy",()=>withTimeout(e.authenticate(),1e4,"Timed out during auth"),e=>({target:"@connecting.busy",effect:assign({authValue:e.data})}),e=>e.reason instanceof O?{target:"@idle.failed",effect:[log(2,e.reason.message),fireErrorEvent(e.reason.message,-1)]}:{target:"@auth.backoff",effect:[increaseBackoffDelay,log(2,`Authentication failed: ${e.reason instanceof Error?e.reason.message:String(e.reason)}`)]});let onSocketError=e=>o.send({type:"EXPLICIT_SOCKET_ERROR",event:e}),onSocketClose=e=>o.send({type:"EXPLICIT_SOCKET_CLOSE",event:e}),onSocketMessage=e=>"pong"===e.data?o.send({type:"PONG"}):n.notify(e);function teardownSocket(e){e&&(e.removeEventListener("error",onSocketError),e.removeEventListener("close",onSocketClose),e.removeEventListener("message",onSocketMessage),e.close())}o.addTransitions("@connecting.backoff",{NAVIGATOR_ONLINE:{target:"@connecting.busy",effect:assign({backoffDelay:k})}}).addTimedTransition("@connecting.backoff",e=>e.backoffDelay,"@connecting.busy").onEnterAsync("@connecting.busy",async(n,i)=>{let o=null,r=null,s=new Promise((i,s)=>{if(null===n.authValue)throw Error("No auth authValue");let a=e.createSocket(n.authValue);function reject(e){o=e,a.removeEventListener("message",onSocketMessage),s(e)}r=a;let[d,c]=controlledPromise();function waitForActorId(e){let t=tryParseJson(e.data);t?.type===104&&c()}t.waitForActorId||c(),a.addEventListener("message",onSocketMessage),t.waitForActorId&&a.addEventListener("message",waitForActorId),a.addEventListener("error",reject),a.addEventListener("close",reject),a.addEventListener("open",()=>{a.addEventListener("error",onSocketError),a.addEventListener("close",onSocketClose);let unsub=()=>{a.removeEventListener("error",reject),a.removeEventListener("close",reject),a.removeEventListener("message",waitForActorId)};d.then(()=>{i([a,unsub])})})});return withTimeout(s,1e4,"Timed out during websocket connection").then(([e,t])=>{if(t(),i.aborted)throw Error("Aborted");if(o)throw o;return e}).catch(e=>{throw teardownSocket(r),e})},e=>({target:"@ok.connected",effect:assign({socket:e.data,backoffDelay:k})}),e=>{let t=e.reason;if(t instanceof O)return{target:"@idle.failed",effect:[log(2,t.message),fireErrorEvent(t.message,-1)]};if(isCloseEvent(t)){if(4109===t.code)return"@auth.busy";if(shouldRetryWithoutReauth(t.code))return{target:"@connecting.backoff",effect:[increaseBackoffDelayAggressively,logPrematureErrorOrCloseEvent(t)]};if(shouldDisconnect(t.code))return{target:"@idle.failed",effect:[log(2,t.reason),fireErrorEvent(t.reason,t.code)]}}return{target:"@auth.backoff",effect:[increaseBackoffDelay,logPrematureErrorOrCloseEvent(t)]}});let r={target:"@ok.awaiting-pong",effect:e=>{e.socket?.send("ping")}},maybeHeartbeat=()=>{let t="undefined"!=typeof document?document:void 0,n=t?.visibilityState==="hidden"&&e.canZombie();return n?"@idle.zombie":r};if(o.addTimedTransition("@ok.connected",3e4,maybeHeartbeat).addTransitions("@ok.connected",{NAVIGATOR_OFFLINE:maybeHeartbeat,WINDOW_GOT_FOCUS:r}),o.addTransitions("@idle.zombie",{WINDOW_GOT_FOCUS:"@connecting.backoff"}),o.onEnter("@ok.*",e=>{e.patch({successCount:e.successCount+1});let t=setTimeout(n.unpause,0);return e=>{teardownSocket(e.socket),e.patch({socket:null}),clearTimeout(t),n.pause()}}).addTransitions("@ok.awaiting-pong",{PONG:"@ok.connected"}).addTimedTransition("@ok.awaiting-pong",2e3,{target:"@connecting.busy",effect:log(1,"Received no pong from server, assume implicit connection loss.")}).addTransitions("@ok.*",{EXPLICIT_SOCKET_ERROR:(e,t)=>t.socket?.readyState===1?null:{target:"@connecting.backoff",effect:increaseBackoffDelay},EXPLICIT_SOCKET_CLOSE:e=>shouldDisconnect(e.event.code)?{target:"@idle.failed",effect:[I,fireErrorEvent(e.event.reason,e.event.code)]}:shouldReauth(e.event.code)?4109===e.event.code?"@auth.busy":{target:"@auth.backoff",effect:[increaseBackoffDelay,logCloseEvent(e.event)]}:shouldRetryWithoutReauth(e.event.code)?{target:"@connecting.backoff",effect:[increaseBackoffDelayAggressively,logCloseEvent(e.event)]}:{target:"@connecting.backoff",effect:[increaseBackoffDelay,logCloseEvent(e.event)]}}),"undefined"!=typeof document){let e="undefined"!=typeof document?document:void 0,t="undefined"!=typeof window?window:void 0,n=t??e;o.onEnter("*",i=>{function onNetworkOffline(){o.send({type:"NAVIGATOR_OFFLINE"})}function onNetworkBackOnline(){o.send({type:"NAVIGATOR_ONLINE"})}function onVisibilityChange(){e?.visibilityState==="visible"&&o.send({type:"WINDOW_GOT_FOCUS"})}return t?.addEventListener("online",onNetworkBackOnline),t?.addEventListener("offline",onNetworkOffline),n?.addEventListener("visibilitychange",onVisibilityChange),()=>{n?.removeEventListener("visibilitychange",onVisibilityChange),t?.removeEventListener("online",onNetworkBackOnline),t?.removeEventListener("offline",onNetworkOffline),teardownSocket(i.socket)}})}let s=[],{statusDidChange:a,didConnect:d,didDisconnect:c,unsubscribe:l}=defineConnectivityEvents(o);return s.push(l),t.enableDebugLogging&&s.push(enableTracing(o)),o.start(),{machine:o,cleanups:s,events:{statusDidChange:a,didConnect:d,didDisconnect:c,onMessage:n.observable,onLiveblocksError:i.observable}}}var C=class{constructor(e,t=!1,n=!0){let{machine:i,events:o,cleanups:r}=createConnectionStateMachine(e,{waitForActorId:n,enableDebugLogging:t});this.machine=i,this.events=o,this.cleanups=r}getLegacyStatus(){return newToLegacyStatus(this.getStatus())}getStatus(){try{return toNewConnectionStatus(this.machine)}catch{return"initial"}}get authValue(){return this.machine.context.authValue}connect(){this.machine.send({type:"CONNECT"})}reconnect(){this.machine.send({type:"RECONNECT"})}disconnect(){this.machine.send({type:"DISCONNECT"})}destroy(){let e;for(this.machine.stop();e=this.cleanups.pop();)e()}send(e){let t=this.machine.context?.socket;null===t?f("Cannot send: not connected yet",e):1!==t.readyState?f("Cannot send: WebSocket no longer open",e):t.send(e)}_privateSendMachineEvent(e){this.machine.send(e)}};function canWriteStorage(e){return e.includes("room:write")}function canComment(e){return e.includes("comments:write")||e.includes("room:write")}function isValidAuthTokenPayload(e){return isPlainObject(e)&&("acc"===e.k||"id"===e.k||"sec-legacy"===e.k)}function parseAuthToken(e){let t=e.split(".");if(3!==t.length)throw Error("Authentication error: invalid JWT token");let n=tryParseJson(b64decode(t[1]));if(!(n&&isValidAuthTokenPayload(n)))throw Error("Authentication error: expected a valid token but did not get one. Hint: if you are using a callback, ensure the room is passed when creating the token. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientCallback");return{raw:e,parsed:n}}function createAuthManager(e){let t=prepareAuthentication(e),n=new Set,i=[],o=[],r=new Map;function hasCorrespondingScopes(e,t){return"comments:read"===e?t.includes("comments:read")||t.includes("comments:write")||t.includes("room:read")||t.includes("room:write"):"room:read"===e&&(t.includes("room:read")||t.includes("room:write"))}function getCachedToken(e){let t=Math.ceil(Date.now()/1e3);for(let n=i.length-1;n>=0;n--){let r=i[n],s=o[n];if(s<=t){i.splice(n,1),o.splice(n,1);continue}if("id"===r.parsed.k)return r;if("acc"===r.parsed.k){if(!e.roomId&&0===Object.entries(r.parsed.perms).length)return r;for(let[t,n]of Object.entries(r.parsed.perms))if(e.roomId){if(t.includes("*")&&e.roomId.startsWith(t.replace("*",""))||e.roomId===t&&hasCorrespondingScopes(e.requestedScope,n))return r}else if(t.includes("*")&&hasCorrespondingScopes(e.requestedScope,n))return r}}}async function makeAuthRequest(i){let o=e.polyfills?.fetch??("undefined"==typeof window?void 0:window.fetch);if("private"===t.type){if(void 0===o)throw new O("To use Liveblocks client in a non-DOM environment with a url as auth endpoint, you need to provide a fetch polyfill.");let e=await fetchAuthEndpoint(o,t.url,{room:i.roomId}),r=parseAuthToken(e.token);if(verifyTokenPermissions(r,i),n.has(r.raw))throw new O("The same Liveblocks auth token was issued from the backend before. Caching Liveblocks tokens is not supported.");return r}if("custom"===t.type){let e=await t.callback(i.roomId);if(e&&"object"==typeof e){if("string"==typeof e.token){let t=parseAuthToken(e.token);return verifyTokenPermissions(t,i),t}if("string"==typeof e.error){let t=`Authentication failed: ${"reason"in e&&"string"==typeof e.reason?e.reason:"Forbidden"}`;if("forbidden"===e.error)throw new O(t);throw Error(t)}}throw Error('Your authentication callback function should return a token, but it did not. Hint: the return value should look like: { token: "..." }')}throw Error("Unexpected authentication type. Must be private or custom.")}function verifyTokenPermissions(e,t){if(!t.roomId&&"acc"===e.parsed.k&&0!==Object.entries(e.parsed.perms).length){for(let[n,i]of Object.entries(e.parsed.perms))if(n.includes("*")&&hasCorrespondingScopes(t.requestedScope,i))return;throw new O("The issued access token doesn't grant enough permissions. Please follow the instructions at https://liveblocks.io/docs/errors/liveblocks-client/access-tokens-not-enough-permissions")}}return{reset:function(){n.clear(),i.length=0,o.length=0,r.clear()},getAuthValue:async function(e){let s;if("public"===t.type)return{type:"public",publicApiKey:t.publicApiKey};let a=getCachedToken(e);if(void 0!==a)return{type:"secret",token:a};e.roomId?void 0===(s=r.get(e.roomId))&&(s=makeAuthRequest(e),r.set(e.roomId,s)):void 0===(s=r.get("liveblocks-user-token"))&&(s=makeAuthRequest(e),r.set("liveblocks-user-token",s));try{let e=await s,t=Math.floor(Date.now()/1e3)+(e.parsed.exp-e.parsed.iat)-30;return n.add(e.raw),"sec-legacy"!==e.parsed.k&&(i.push(e),o.push(t)),{type:"secret",token:e}}finally{e.roomId?r.delete(e.roomId):r.delete("liveblocks-user-token")}}}}function prepareAuthentication(e){let{publicApiKey:t,authEndpoint:n}=e;if(void 0!==n&&void 0!==t)throw Error("You cannot simultaneously use `publicApiKey` and `authEndpoint` options. Please pick one and leave the other option unspecified. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient");if("string"==typeof t){if(t.startsWith("sk_"))throw Error("Invalid `publicApiKey` option. The value you passed is a secret key, which should not be used from the client. Please only ever pass a public key here. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");if(!t.startsWith("pk_"))throw Error("Invalid key. Please use the public key format: pk_<public key>. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientPublicKey");return{type:"public",publicApiKey:t}}if("string"==typeof n)return{type:"private",url:n};if("function"==typeof n)return{type:"custom",callback:n};if(void 0!==n)throw Error("The `authEndpoint` option must be a string or a function. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClientAuthEndpoint");throw Error("Invalid Liveblocks client options. Please provide either a `publicApiKey` or `authEndpoint` option. They cannot both be empty. For more information: https://liveblocks.io/docs/api-reference/liveblocks-client#createClient")}async function fetchAuthEndpoint(e,t,n){let i;let o=await e(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok){let e=`${(await o.text()).trim()||"reason not provided in auth response"} (${o.status} returned by POST ${t})`;if(401===o.status||403===o.status)throw new O(`Unauthorized: ${e}`);throw Error(`Failed to authenticate: ${e}`)}try{i=await o.json()}catch(e){throw Error(`Expected a JSON response when doing a POST request on "${t}". ${String(e)}`)}if(!isPlainObject(i)||"string"!=typeof i.token)throw Error(`Expected a JSON response of the form \`{ token: "..." }\` when doing a POST request on "${t}", but got ${JSON.stringify(i)}`);let{token:r}=i;return{token:r}}var N=Symbol();makeEventSource().observable;var P=Date.now(),L=0;function stringify(e,...t){if("object"!=typeof e||null===e||Array.isArray(e))return JSON.stringify(e,...t);let n=Object.keys(e).sort().reduce((t,n)=>(t[n]=e[n],t),{});return JSON.stringify(n,...t)}var noop=()=>{},D=class{constructor(e){this.resolve=noop,this.reject=noop,this.promise=new Promise(noop),this.args=e}},R=class{constructor(e,t){this.queue=[],this.error=!1,this.callback=e,this.size=t?.size??50,this.delay=t?.delay??100}clearDelayTimeout(){void 0!==this.delayTimeoutId&&(clearTimeout(this.delayTimeoutId),this.delayTimeoutId=void 0)}schedule(){this.queue.length===this.size?this.flush():1===this.queue.length&&(this.clearDelayTimeout(),this.delayTimeoutId=setTimeout(()=>void this.flush(),this.delay))}async flush(){if(0===this.queue.length)return;let e=this.queue.splice(0),t=e.map(e=>e.args);try{let n=await this.callback(t);this.error=!1,e.forEach((t,i)=>{let o=n?.[i];Array.isArray(n)?e.length!==n.length?t.reject(Error(`Callback must return an array of the same length as the number of provided items. Expected ${e.length}, but got ${n.length}.`)):o instanceof Error?t.reject(o):t.resolve(o):t.reject(Error("Callback must return an array."))})}catch(t){this.error=!0,e.forEach(e=>{e.reject(t)})}}get(...e){let t=this.queue.find(t=>stringify(t.args)===stringify(e));if(t)return t.promise;let n=new D(e);return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),this.queue.push(n),this.schedule(),n.promise}clear(){this.queue=[],this.error=!1,this.clearDelayTimeout()}};function createBatchStore(e,t){let n=new R(e,t),i=new Map,o=makeEventSource();function setStateAndNotify(e,t){t?i.set(e,t):i.delete(e),o.notify(t)}async function get(...e){let t=stringify(e);if(!i.has(t))try{setStateAndNotify(t,{isLoading:!0});let i=await n.get(...e);setStateAndNotify(t,{isLoading:!1,data:i})}catch(e){setStateAndNotify(t,{isLoading:!1,error:e})}}function getState(...e){let t=stringify(e);return i.get(t)}return{...o,get,getState}}function createStore(e){let t=e,n=new Set;return{get:function(){return t},set:function(e){let i=e(t);if(t!==i)for(let e of(t=i,n))e(t)},subscribe:function(e){return n.add(e),e(t),()=>{n.delete(e)}}}}function convertToCommentData(e){let t=e.editedAt?new Date(e.editedAt):void 0,n=new Date(e.createdAt),i=e.reactions.map(e=>({...e,createdAt:new Date(e.createdAt)}));if(e.body)return{...e,reactions:i,createdAt:n,editedAt:t};{let o=new Date(e.deletedAt);return{...e,reactions:i,createdAt:n,editedAt:t,deletedAt:o}}}function convertToThreadData(e){let t=e.updatedAt?new Date(e.updatedAt):void 0,n=new Date(e.createdAt),i=e.comments.map(e=>convertToCommentData(e));return{...e,createdAt:n,updatedAt:t,comments:i}}function convertToCommentUserReaction(e){return{...e,createdAt:new Date(e.createdAt)}}function convertToInboxNotificationData(e){let t=new Date(e.notifiedAt),n=e.readAt?new Date(e.readAt):null;return{...e,notifiedAt:t,readAt:n}}function convertToThreadDeleteInfo(e){let t=new Date(e.deletedAt);return{...e,deletedAt:t}}function convertToInboxNotificationDeleteInfo(e){let t=new Date(e.deletedAt);return{...e,deletedAt:t}}function toURLSearchParams(e){let t=new URLSearchParams;for(let[n,i]of Object.entries(e))null!=i&&t.set(n,i.toString());return t}function urljoin(e,t,n){let i=new URL(t,e);return void 0!==n&&(i.search=(n instanceof URLSearchParams?n:toURLSearchParams(n)).toString()),i.toString()}function createNotificationsApi({baseUrl:e,authManager:t,currentUserIdStore:n,fetcher:i}){async function fetchJson(o,r,s){let a;let d=await t.getAuthValue({requestedScope:"comments:read"});if("secret"===d.type&&"acc"===d.token.parsed.k){let e=d.token.parsed.uid;n.set(()=>e)}let c=urljoin(e,`/v2/c${o}`,s),l=await i(c.toString(),{...r,headers:{...r?.headers,Authorization:`Bearer ${getAuthBearerHeaderFromAuthValue(d)}`}});if(!l.ok&&l.status>=400&&l.status<600){let e;try{let t=await l.json();e=new ee(t.message,l.status,t)}catch{e=new ee(l.statusText,l.status)}throw e}try{a=await l.json()}catch{a={}}return a}async function getInboxNotifications(e){let t=await fetchJson("/inbox-notifications",void 0,{limit:e?.limit,since:e?.since?.toISOString()});return{threads:t.threads.map(e=>convertToThreadData(e)),inboxNotifications:t.inboxNotifications.map(e=>convertToInboxNotificationData(e)),deletedThreads:t.deletedThreads.map(e=>convertToThreadDeleteInfo(e)),deletedInboxNotifications:t.deletedInboxNotifications.map(e=>convertToInboxNotificationDeleteInfo(e)),meta:{requestedAt:new Date(t.meta.requestedAt)}}}async function getUnreadInboxNotificationsCount(){let{count:e}=await fetchJson("/inbox-notifications/count");return e}async function markAllInboxNotificationsAsRead(){await fetchJson("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:"all"})})}async function markInboxNotificationsAsRead(e){await fetchJson("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:e})})}let o=new R(async e=>{let t=e.flat();return await markInboxNotificationsAsRead(t),t},{delay:50});return{getInboxNotifications,getUnreadInboxNotificationsCount,markAllInboxNotificationsAsRead,markInboxNotificationAsRead:async function(e){await o.get(e)}}}var U=nthDigit(0),x=nthDigit(1),M=U+nthDigit(-1);function nthDigit(e){let t=32+(e<0?95+e:e);if(t<32||t>126)throw Error(`Invalid n value: ${e}`);return String.fromCharCode(t)}function makePosition(e,t){return void 0!==e&&void 0!==t?between(e,t):void 0!==e?after(e):void 0!==t?before(t):x}function before(e){let t=e.length-1;for(let n=0;n<=t;n++){let i=e.charCodeAt(n);if(!(i<=32)){if(n!==t)return e.substring(0,n+1);if(33===i)return e.substring(0,n)+M;return e.substring(0,n)+String.fromCharCode(i-1)}}return x}function after(e){for(let t=0;t<=e.length-1;t++){let n=e.charCodeAt(t);if(!(n>=126))return e.substring(0,t)+String.fromCharCode(n+1)}return e+x}function between(e,t){if(e<t)return _between(e,t);if(e>t)return _between(t,e);throw Error("Cannot compute value between two equal positions")}function _between(e,t){let n=0,i=e.length,o=t.length;for(;;){let r=n<i?e.charCodeAt(n):32,s=n<o?t.charCodeAt(n):126;if(r===s){n++;continue}if(s-r!=1)return takeN(e,n)+String.fromCharCode(s+r>>1);{let t=n+1,i=e.substring(0,t);i.length<t&&(i+=U.repeat(t-i.length));let o=e.substring(t);return i+_between(o,"")}}}function takeN(e,t){return t<e.length?e.substring(0,t):e+U.repeat(t-e.length)}function isPos(e){if(""===e)return!1;let t=e.length-1,n=e.charCodeAt(t);if(n<33||n>126)return!1;for(let n=0;n<t;n++){let t=e.charCodeAt(n);if(t<32||t>126)return!1}return!0}function convertToPos(e){let t=[];for(let n=0;n<e.length;n++){let i=e.charCodeAt(n);t.push(i<32?32:i>126?126:i)}for(;t.length>0&&32===t[t.length-1];)t.length--;return t.length>0?String.fromCharCode(...t):x}function asPos(e){return isPos(e)?e:convertToPos(e)}var j=((r=j||{})[r.INIT=0]="INIT",r[r.SET_PARENT_KEY=1]="SET_PARENT_KEY",r[r.CREATE_LIST=2]="CREATE_LIST",r[r.UPDATE_OBJECT=3]="UPDATE_OBJECT",r[r.CREATE_OBJECT=4]="CREATE_OBJECT",r[r.DELETE_CRDT=5]="DELETE_CRDT",r[r.DELETE_OBJECT_KEY=6]="DELETE_OBJECT_KEY",r[r.CREATE_MAP=7]="CREATE_MAP",r[r.CREATE_REGISTER=8]="CREATE_REGISTER",r);function isAckOp(e){return 5===e.type&&"ACK"===e.id}function HasParent(e,t,n=asPos(t)){return Object.freeze({type:"HasParent",node:e,key:t,pos:n})}var K=Object.freeze({type:"NoParent"});function Orphaned(e,t=asPos(e)){return Object.freeze({type:"Orphaned",oldKey:e,oldPos:t})}var B=class{constructor(){this._parent=K}_getParentKeyOrThrow(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":throw Error("Parent key is missing");case"Orphaned":return this.parent.oldKey;default:return assertNever(this.parent,"Unknown state")}}get _parentPos(){switch(this.parent.type){case"HasParent":return this.parent.pos;case"NoParent":throw Error("Parent key is missing");case"Orphaned":return this.parent.oldPos;default:return assertNever(this.parent,"Unknown state")}}get _pool(){return this.__pool}get roomId(){return this.__pool?this.__pool.roomId:null}get _id(){return this.__id}get parent(){return this._parent}get _parentKey(){switch(this.parent.type){case"HasParent":return this.parent.key;case"NoParent":return null;case"Orphaned":return this.parent.oldKey;default:return assertNever(this.parent,"Unknown state")}}_apply(e,t){return 5===e.type&&"HasParent"===this.parent.type?this.parent.node._detachChild(this):{modified:!1}}_setParentLink(e,t){switch(this.parent.type){case"HasParent":if(this.parent.node!==e)throw Error("Cannot set parent: node already has a parent");this._parent=HasParent(e,t);return;case"Orphaned":case"NoParent":this._parent=HasParent(e,t);return;default:return assertNever(this.parent,"Unknown state")}}_attach(e,t){if(this.__id||this.__pool)throw Error("Cannot attach node: already attached");t.addNode(e,this),this.__id=e,this.__pool=t}_detach(){switch(this.__pool&&this.__id&&this.__pool.deleteNode(this.__id),this.parent.type){case"HasParent":this._parent=Orphaned(this.parent.key,this.parent.pos);break;case"NoParent":this._parent=K;break;case"Orphaned":break;default:assertNever(this.parent,"Unknown state")}this.__pool=void 0}invalidate(){(void 0!==this._cachedImmutable||void 0!==this._cachedTreeNode)&&(this._cachedImmutable=void 0,this._cachedTreeNode=void 0,"HasParent"===this.parent.type&&this.parent.node.invalidate())}toTreeNode(e){return(void 0===this._cachedTreeNode||this._cachedTreeNodeKey!==e)&&(this._cachedTreeNodeKey=e,this._cachedTreeNode=this._toTreeNode(e)),this._cachedTreeNode}toImmutable(){return void 0===this._cachedImmutable&&(this._cachedImmutable=this._toImmutable()),this._cachedImmutable}},$=((s=$||{})[s.OBJECT=0]="OBJECT",s[s.LIST=1]="LIST",s[s.MAP=2]="MAP",s[s.REGISTER=3]="REGISTER",s);function isRootCrdt(e){return 0===e.type&&!isChildCrdt(e)}function isChildCrdt(e){return void 0!==e.parentId&&void 0!==e.parentKey}function nanoid(e=7){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789,./;[]~!@#$%&*()_+=-",n=t.length;return Array.from({length:e},()=>t.charAt(Math.floor(Math.random()*n))).join("")}var H=class _LiveRegister extends B{constructor(e){super(),this._data=e}get data(){return this._data}static _deserialize([e,t],n,i){let o=new _LiveRegister(t.data);return o._attach(e,i),o}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize register if parentId or parentKey is undefined");return[{type:8,opId:n?.generateOpId(),id:this._id,parentId:e,parentKey:t,data:this.data}]}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveRegister if parent is missing");return{type:3,parentId:nn(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key,data:this.data}}_attachChild(e){throw Error("Method not implemented.")}_detachChild(e){throw Error("Method not implemented.")}_apply(e,t){return super._apply(e,t)}_toTreeNode(e){return{type:"Json",id:this._id??nanoid(),key:e,payload:this._data}}_toImmutable(){return this._data}clone(){return deepClone(this.data)}};function compareNodePosition(e,t){let n=e._parentPos,i=t._parentPos;return n===i?0:n<i?-1:1}var z=class _LiveList extends B{constructor(e=[]){let t;for(let n of(super(),this._items=[],this._implicitlyDeletedItems=new WeakSet,this._unacknowledgedSets=new Map,e)){let e=makePosition(t),i=lsonToLiveNode(n);i._setParentLink(this,e),this._items.push(i),t=e}}static _deserialize([e],t,n){let i=new _LiveList;i._attach(e,n);let o=t.get(e);if(void 0===o)return i;for(let[e,r]of o){let o=deserialize([e,r],t,n);o._setParentLink(i,r.parentKey),i._insertAndSort(o)}return i}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let i=[],o={id:this._id,opId:n?.generateOpId(),type:2,parentId:e,parentKey:t};for(let e of(i.push(o),this._items)){let t=e._getParentKeyOrThrow(),o=HACK_addIntentAndDeletedIdToOperation(e._toOps(this._id,t,n),void 0),r=o[0].opId;void 0!==r&&this._unacknowledgedSets.set(t,r),i.push(...o)}return i}_insertAndSort(e){this._items.push(e),this._sortItems()}_sortItems(){this._items.sort(compareNodePosition),this.invalidate()}_indexOfPosition(e){return this._items.findIndex(t=>t._getParentKeyOrThrow()===e)}_attach(e,t){for(let n of(super._attach(e,t),this._items))n._attach(t.generateId(),t)}_detach(){for(let e of(super._detach(),this._items))e._detach()}_applySetRemote(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:t,parentKey:n}=e,i=creationOpToLiveNode(e);i._attach(t,this._pool),i._setParentLink(this,n);let o=e.deletedId,r=this._indexOfPosition(n);if(-1!==r){let t=this._items[r];if(t._id===o)return t._detach(),this._items[r]=i,{modified:makeUpdate(this,[setDelta(r,i)]),reverse:[]};{this._implicitlyDeletedItems.add(t),this._items[r]=i;let n=[setDelta(r,i)],o=this._detachItemAssociatedToSetOperation(e.deletedId);return o&&n.push(o),{modified:makeUpdate(this,n),reverse:[]}}}{let t=[],o=this._detachItemAssociatedToSetOperation(e.deletedId);return o&&t.push(o),this._insertAndSort(i),t.push(insertDelta(this._indexOfPosition(n),i)),{reverse:[],modified:makeUpdate(this,t)}}}_applySetAck(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let t=[],n=this._detachItemAssociatedToSetOperation(e.deletedId);n&&t.push(n);let i=this._unacknowledgedSets.get(e.parentKey);if(void 0!==i){if(i!==e.opId)return 0===t.length?{modified:!1}:{modified:makeUpdate(this,t),reverse:[]};this._unacknowledgedSets.delete(e.parentKey)}let o=this._indexOfPosition(e.parentKey),r=this._items.find(t=>t._id===e.id);if(void 0!==r){if(r._parentKey===e.parentKey)return{modified:t.length>0&&makeUpdate(this,t),reverse:[]};-1!==o&&(this._implicitlyDeletedItems.add(this._items[o]),this._items.splice(o,1),t.push(deleteDelta(o)));let n=this._items.indexOf(r);r._setParentLink(this,e.parentKey),this._sortItems();let i=this._items.indexOf(r);return i!==n&&t.push(moveDelta(n,i,r)),{modified:t.length>0&&makeUpdate(this,t),reverse:[]}}{let n=this._pool.getNode(e.id);if(n&&this._implicitlyDeletedItems.has(n)){n._setParentLink(this,e.parentKey),this._implicitlyDeletedItems.delete(n),this._insertAndSort(n);let i=this._items.indexOf(n);return{modified:makeUpdate(this,[-1===o?insertDelta(i,n):setDelta(i,n),...t]),reverse:[]}}{-1!==o&&this._items.splice(o,1);let{newItem:n,newIndex:i}=this._createAttachItemAndSort(e,e.parentKey);return{modified:makeUpdate(this,[-1===o?insertDelta(i,n):setDelta(i,n),...t]),reverse:[]}}}}_detachItemAssociatedToSetOperation(e){if(void 0===e||void 0===this._pool)return null;let t=this._pool.getNode(e);if(void 0===t)return null;let n=this._detachChild(t);return!1===n.modified?null:n.modified.updates[0]}_applyRemoteInsert(e){if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let t=asPos(e.parentKey),n=this._indexOfPosition(t);-1!==n&&this._shiftItemPosition(n,t);let{newItem:i,newIndex:o}=this._createAttachItemAndSort(e,t);return{modified:makeUpdate(this,[insertDelta(o,i)]),reverse:[]}}_applyInsertAck(e){let t=this._items.find(t=>t._id===e.id),n=asPos(e.parentKey),i=this._indexOfPosition(n);if(t){if(t._parentKey===n)return{modified:!1};{let e=this._items.indexOf(t);-1!==i&&this._shiftItemPosition(i,n),t._setParentLink(this,n),this._sortItems();let o=this._indexOfPosition(n);return o===e?{modified:!1}:{modified:makeUpdate(this,[moveDelta(e,o,t)]),reverse:[]}}}{let t=nn(this._pool).getNode(e.id);if(t&&this._implicitlyDeletedItems.has(t)){t._setParentLink(this,n),this._implicitlyDeletedItems.delete(t),this._insertAndSort(t);let e=this._indexOfPosition(n);return{modified:makeUpdate(this,[insertDelta(e,t)]),reverse:[]}}{-1!==i&&this._shiftItemPosition(i,n);let{newItem:t,newIndex:o}=this._createAttachItemAndSort(e,n);return{modified:makeUpdate(this,[insertDelta(o,t)]),reverse:[]}}}}_applyInsertUndoRedo(e){let{id:t,parentKey:n}=e,i=creationOpToLiveNode(e);if(this._pool?.getNode(t)!==void 0)return{modified:!1};i._attach(t,nn(this._pool)),i._setParentLink(this,n);let o=this._indexOfPosition(n),r=n;if(-1!==o){let e=this._items[o]?._parentPos,t=this._items[o+1]?._parentPos;r=makePosition(e,t),i._setParentLink(this,r)}this._insertAndSort(i);let s=this._indexOfPosition(r);return{modified:makeUpdate(this,[insertDelta(s,i)]),reverse:[{type:5,id:t}]}}_applySetUndoRedo(e){let{id:t,parentKey:n}=e,i=creationOpToLiveNode(e);if(this._pool?.getNode(t)!==void 0)return{modified:!1};this._unacknowledgedSets.set(n,nn(e.opId));let o=this._indexOfPosition(n);if(i._attach(t,nn(this._pool)),i._setParentLink(this,n),-1!==o){let t=this._items[o];t._detach(),this._items[o]=i;let r=HACK_addIntentAndDeletedIdToOperation(t._toOps(nn(this._id),n,this._pool),e.id),s=[setDelta(o,i)],a=this._detachItemAssociatedToSetOperation(e.deletedId);return a&&s.push(a),{modified:makeUpdate(this,s),reverse:r}}{this._insertAndSort(i),this._detachItemAssociatedToSetOperation(e.deletedId);let o=this._indexOfPosition(n);return{reverse:[{type:5,id:t}],modified:makeUpdate(this,[insertDelta(o,i)])}}}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");return!1!==(n="set"===e.intent?1===t?this._applySetRemote(e):2===t?this._applySetAck(e):this._applySetUndoRedo(e):1===t?this._applyRemoteInsert(e):2===t?this._applyInsertAck(e):this._applyInsertUndoRedo(e)).modified&&this.invalidate(),n}_detachChild(e){if(e){let t=nn(e._parentKey),n=e._toOps(nn(this._id),t,this._pool),i=this._items.indexOf(e);return -1===i?{modified:!1}:(this._items.splice(i,1),this.invalidate(),e._detach(),{modified:makeUpdate(this,[deleteDelta(i)]),reverse:n})}return{modified:!1}}_applySetChildKeyRemote(e,t){if(this._implicitlyDeletedItems.has(t)){this._implicitlyDeletedItems.delete(t),t._setParentLink(this,e),this._insertAndSort(t);let n=this._items.indexOf(t);return{modified:makeUpdate(this,[insertDelta(n,t)]),reverse:[]}}let n=t._parentKey;if(e===n)return{modified:!1};let i=this._indexOfPosition(e);if(-1===i){let n=this._items.indexOf(t);t._setParentLink(this,e),this._sortItems();let i=this._items.indexOf(t);return i===n?{modified:!1}:{modified:makeUpdate(this,[moveDelta(n,i,t)]),reverse:[]}}{this._items[i]._setParentLink(this,makePosition(e,this._items[i+1]?._parentPos));let n=this._items.indexOf(t);t._setParentLink(this,e),this._sortItems();let o=this._items.indexOf(t);return o===n?{modified:!1}:{modified:makeUpdate(this,[moveDelta(n,o,t)]),reverse:[]}}}_applySetChildKeyAck(e,t){let n=nn(t._parentKey);if(this._implicitlyDeletedItems.has(t)){let n=this._indexOfPosition(e);return this._implicitlyDeletedItems.delete(t),-1!==n&&this._items[n]._setParentLink(this,makePosition(e,this._items[n+1]?._parentPos)),t._setParentLink(this,e),this._insertAndSort(t),{modified:!1}}{if(e===n)return{modified:!1};let i=this._items.indexOf(t),o=this._indexOfPosition(e);-1!==o&&this._items[o]._setParentLink(this,makePosition(e,this._items[o+1]?._parentPos)),t._setParentLink(this,e),this._sortItems();let r=this._items.indexOf(t);return i===r?{modified:!1}:{modified:makeUpdate(this,[moveDelta(i,r,t)]),reverse:[]}}}_applySetChildKeyUndoRedo(e,t){let n=nn(t._parentKey),i=this._items.indexOf(t),o=this._indexOfPosition(e);-1!==o&&this._items[o]._setParentLink(this,makePosition(e,this._items[o+1]?._parentPos)),t._setParentLink(this,e),this._sortItems();let r=this._items.indexOf(t);return i===r?{modified:!1}:{modified:makeUpdate(this,[moveDelta(i,r,t)]),reverse:[{type:1,id:nn(t._id),parentKey:n}]}}_setChildKey(e,t,n){return 1===n?this._applySetChildKeyRemote(e,t):2===n?this._applySetChildKeyAck(e,t):this._applySetChildKeyUndoRedo(e,t)}_apply(e,t){return super._apply(e,t)}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveList if parent is missing");return{type:1,parentId:nn(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get length(){return this._items.length}push(e){return this._pool?.assertStorageIsWritable(),this.insert(e,this.length)}insert(e,t){if(this._pool?.assertStorageIsWritable(),t<0||t>this._items.length)throw Error(`Cannot insert list item at index "${t}". index should be between 0 and ${this._items.length}`);let n=this._items[t-1]?this._items[t-1]._parentPos:void 0,i=this._items[t]?this._items[t]._parentPos:void 0,o=makePosition(n,i),r=lsonToLiveNode(e);if(r._setParentLink(this,o),this._insertAndSort(r),this._pool&&this._id){let e=this._pool.generateId();r._attach(e,this._pool),this._pool.dispatch(r._toOps(this._id,o,this._pool),[{type:5,id:e}],new Map([[this._id,makeUpdate(this,[insertDelta(t,r)])]]))}}move(e,t){if(this._pool?.assertStorageIsWritable(),t<0)throw Error("targetIndex cannot be less than 0");if(t>=this._items.length)throw Error("targetIndex cannot be greater or equal than the list length");if(e<0)throw Error("index cannot be less than 0");if(e>=this._items.length)throw Error("index cannot be greater or equal than the list length");let n=null,i=null;e<t?(i=t===this._items.length-1?void 0:this._items[t+1]._parentPos,n=this._items[t]._parentPos):(i=this._items[t]._parentPos,n=0===t?void 0:this._items[t-1]._parentPos);let o=makePosition(n,i),r=this._items[e],s=r._getParentKeyOrThrow();if(r._setParentLink(this,o),this._sortItems(),this._pool&&this._id){let n=new Map([[this._id,makeUpdate(this,[moveDelta(e,t,r)])]]);this._pool.dispatch([{type:1,id:nn(r._id),opId:this._pool.generateOpId(),parentKey:o}],[{type:1,id:nn(r._id),parentKey:s}],n)}}delete(e){if(this._pool?.assertStorageIsWritable(),e<0||e>=this._items.length)throw Error(`Cannot delete list item at index "${e}". index should be between 0 and ${this._items.length-1}`);let t=this._items[e];if(t._detach(),this._items.splice(e,1),this.invalidate(),this._pool){let n=t._id;if(n){let i=new Map;i.set(nn(this._id),makeUpdate(this,[deleteDelta(e)])),this._pool.dispatch([{id:n,opId:this._pool.generateOpId(),type:5}],t._toOps(nn(this._id),t._getParentKeyOrThrow()),i)}}}clear(){if(this._pool?.assertStorageIsWritable(),this._pool){let e=[],t=[],n=[];for(let i of this._items){i._detach();let o=i._id;o&&(e.push({type:5,id:o,opId:this._pool.generateOpId()}),t.push(...i._toOps(nn(this._id),i._getParentKeyOrThrow())),n.push(deleteDelta(0)))}this._items=[],this.invalidate();let i=new Map;i.set(nn(this._id),makeUpdate(this,n)),this._pool.dispatch(e,t,i)}else{for(let e of this._items)e._detach();this._items=[],this.invalidate()}}set(e,t){if(this._pool?.assertStorageIsWritable(),e<0||e>=this._items.length)throw Error(`Cannot set list item at index "${e}". index should be between 0 and ${this._items.length-1}`);let n=this._items[e],i=n._getParentKeyOrThrow(),o=n._id;n._detach();let r=lsonToLiveNode(t);if(r._setParentLink(this,i),this._items[e]=r,this.invalidate(),this._pool&&this._id){let t=this._pool.generateId();r._attach(t,this._pool);let s=new Map;s.set(this._id,makeUpdate(this,[setDelta(e,r)]));let a=HACK_addIntentAndDeletedIdToOperation(r._toOps(this._id,i,this._pool),o);this._unacknowledgedSets.set(i,nn(a[0].opId));let d=HACK_addIntentAndDeletedIdToOperation(n._toOps(this._id,i,void 0),t);this._pool.dispatch(a,d,s)}}toArray(){return this._items.map(e=>liveNodeToLson(e))}every(e){return this.toArray().every(e)}filter(e){return this.toArray().filter(e)}find(e){return this.toArray().find(e)}findIndex(e){return this.toArray().findIndex(e)}forEach(e){return this.toArray().forEach(e)}get(e){if(!(e<0)&&!(e>=this._items.length))return liveNodeToLson(this._items[e])}indexOf(e,t){return this.toArray().indexOf(e,t)}lastIndexOf(e,t){return this.toArray().lastIndexOf(e,t)}map(e){return this._items.map((t,n)=>e(liveNodeToLson(t),n))}some(e){return this.toArray().some(e)}[Symbol.iterator](){return new J(this._items)}_createAttachItemAndSort(e,t){let n=creationOpToLiveNode(e);n._attach(e.id,nn(this._pool)),n._setParentLink(this,t),this._insertAndSort(n);let i=this._indexOfPosition(t);return{newItem:n,newIndex:i}}_shiftItemPosition(e,t){let n=makePosition(t,this._items.length>e+1?this._items[e+1]?._parentPos:void 0);this._items[e]._setParentLink(this,n)}_toTreeNode(e){return{type:"LiveList",id:this._id??nanoid(),key:e,payload:this._items.map((e,t)=>e.toTreeNode(t.toString()))}}toImmutable(){return super.toImmutable()}_toImmutable(){let e=this._items.map(e=>e.toImmutable());return e}clone(){return new _LiveList(this._items.map(e=>e.clone()))}},J=class{constructor(e){this._innerIterator=e[Symbol.iterator]()}[Symbol.iterator](){return this}next(){let e=this._innerIterator.next();if(e.done)return{done:!0,value:void 0};let t=liveNodeToLson(e.value);return{value:t}}};function makeUpdate(e,t){return{node:e,type:"LiveList",updates:t}}function setDelta(e,t){return{index:e,type:"set",item:t instanceof H?t.data:t}}function deleteDelta(e){return{index:e,type:"delete"}}function insertDelta(e,t){return{index:e,type:"insert",item:t instanceof H?t.data:t}}function moveDelta(e,t,n){return{index:t,type:"move",previousIndex:e,item:n instanceof H?n.data:n}}function HACK_addIntentAndDeletedIdToOperation(e,t){return e.map((e,n)=>0===n?{...e,intent:"set",deletedId:t}:e)}var freeze=e=>e,F=class _LiveMap extends B{constructor(e){if(super(),this.unacknowledgedSet=new Map,e){let t=[];for(let[n,i]of e){let e=lsonToLiveNode(i);e._setParentLink(this,n),t.push([n,e])}this._map=new Map(t)}else this._map=new Map}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let i=[],o={id:this._id,opId:n?.generateOpId(),type:7,parentId:e,parentKey:t};for(let[e,t]of(i.push(o),this._map))i.push(...t._toOps(this._id,e,n));return i}static _deserialize([e,t],n,i){let o=new _LiveMap;o._attach(e,i);let r=n.get(e);if(void 0===r)return o;for(let[e,t]of r){let r=deserialize([e,t],n,i);r._setParentLink(o,t.parentKey),o._map.set(t.parentKey,r),o.invalidate()}return o}_attach(e,t){for(let[n,i]of(super._attach(e,t),this._map))isLiveNode(i)&&i._attach(t.generateId(),t)}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:i,parentKey:o,opId:r}=e,s=creationOpToLiveNode(e);if(void 0!==this._pool.getNode(i))return{modified:!1};if(2===t){let e=this.unacknowledgedSet.get(o);if(e===r)return this.unacknowledgedSet.delete(o),{modified:!1};if(void 0!==e)return{modified:!1}}else 1===t&&this.unacknowledgedSet.delete(o);let a=this._map.get(o);if(a){let e=nn(this._id);n=a._toOps(e,o),a._detach()}else n=[{type:5,id:i}];return s._setParentLink(this,o),s._attach(i,this._pool),this._map.set(o,s),this.invalidate(),{modified:{node:this,type:"LiveMap",updates:{[o]:{type:"update"}}},reverse:n}}_detach(){for(let e of(super._detach(),this._map.values()))e._detach()}_detachChild(e){let t=nn(this._id),n=nn(e._parentKey),i=e._toOps(t,n,this._pool);for(let[t,n]of this._map)n===e&&(this._map.delete(t),this.invalidate());return e._detach(),{modified:{node:this,type:"LiveMap",updates:{[n]:{type:"delete"}}},reverse:i}}_serialize(){if("HasParent"!==this.parent.type)throw Error("Cannot serialize LiveMap if parent is missing");return{type:2,parentId:nn(this.parent.node._id,"Parent node expected to have ID"),parentKey:this.parent.key}}get(e){let t=this._map.get(e);if(void 0!==t)return liveNodeToLson(t)}set(e,t){this._pool?.assertStorageIsWritable();let n=this._map.get(e);n&&n._detach();let i=lsonToLiveNode(t);if(i._setParentLink(this,e),this._map.set(e,i),this.invalidate(),this._pool&&this._id){let t=this._pool.generateId();i._attach(t,this._pool);let o=new Map;o.set(this._id,{node:this,type:"LiveMap",updates:{[e]:{type:"update"}}});let r=i._toOps(this._id,e,this._pool);this.unacknowledgedSet.set(e,nn(r[0].opId)),this._pool.dispatch(i._toOps(this._id,e,this._pool),n?n._toOps(this._id,e):[{type:5,id:t}],o)}}get size(){return this._map.size}has(e){return this._map.has(e)}delete(e){this._pool?.assertStorageIsWritable();let t=this._map.get(e);if(void 0===t)return!1;if(t._detach(),this._map.delete(e),this.invalidate(),this._pool&&t._id){let n=nn(this._id),i=new Map;i.set(n,{node:this,type:"LiveMap",updates:{[e]:{type:"delete"}}}),this._pool.dispatch([{type:5,id:t._id,opId:this._pool.generateOpId()}],t._toOps(n,e),i)}return!0}entries(){let e=this._map.entries();return{[Symbol.iterator](){return this},next(){let t=e.next();if(t.done)return{done:!0,value:void 0};let n=t.value,i=n[0],o=liveNodeToLson(t.value[1]);return{value:[i,o]}}}}[Symbol.iterator](){return this.entries()}keys(){return this._map.keys()}values(){let e=this._map.values();return{[Symbol.iterator](){return this},next(){let t=e.next();if(t.done)return{done:!0,value:void 0};let n=liveNodeToLson(t.value);return{value:n}}}}forEach(e){for(let t of this)e(t[1],t[0],this)}_toTreeNode(e){return{type:"LiveMap",id:this._id??nanoid(),key:e,payload:Array.from(this._map.entries()).map(([e,t])=>t.toTreeNode(e))}}toImmutable(){return super.toImmutable()}_toImmutable(){let e=new Map;for(let[t,n]of this._map)e.set(t,n.toImmutable());return freeze(e)}clone(){return new _LiveMap(Array.from(this._map).map(([e,t])=>[e,t.clone()]))}},W=class _LiveObject extends B{constructor(e={}){super(),this._propToLastUpdate=new Map;let t=compactObject(e);for(let e of Object.keys(t)){let n=t[e];isLiveNode(n)&&n._setParentLink(this,e)}this._map=new Map(Object.entries(t))}static _buildRootAndParentToChildren(e){let t=new Map,n=null;for(let[i,o]of e)if(isRootCrdt(o))n=[i,o];else{let e=[i,o],n=t.get(o.parentId);void 0!==n?n.push(e):t.set(o.parentId,[e])}if(null===n)throw Error("Root can't be null");return[n,t]}static _fromItems(e,t){let[n,i]=_LiveObject._buildRootAndParentToChildren(e);return _LiveObject._deserialize(n,i,t)}_toOps(e,t,n){if(void 0===this._id)throw Error("Cannot serialize item is not attached");let i=n?.generateOpId(),o=[],r={type:4,id:this._id,opId:i,parentId:e,parentKey:t,data:{}};for(let[e,t]of(o.push(r),this._map))isLiveNode(t)?o.push(...t._toOps(this._id,e,n)):r.data[e]=t;return o}static _deserialize([e,t],n,i){let o=new _LiveObject(t.data);return o._attach(e,i),this._deserializeChildren(o,n,i)}static _deserializeChildren(e,t,n){let i=t.get(nn(e._id));if(void 0===i)return e;for(let[o,r]of i){let i=deserializeToLson([o,r],t,n);isLiveStructure(i)&&i._setParentLink(e,r.parentKey),e._map.set(r.parentKey,i),e.invalidate()}return e}_attach(e,t){for(let[n,i]of(super._attach(e,t),this._map))isLiveNode(i)&&i._attach(t.generateId(),t)}_attachChild(e,t){let n;if(void 0===this._pool)throw Error("Can't attach child if managed pool is not present");let{id:i,opId:o,parentKey:r}=e,s=creationOpToLson(e);if(void 0!==this._pool.getNode(i))return this._propToLastUpdate.get(r)===o&&this._propToLastUpdate.delete(r),{modified:!1};if(0===t)this._propToLastUpdate.set(r,nn(o));else if(void 0===this._propToLastUpdate.get(r));else if(this._propToLastUpdate.get(r)===o)return this._propToLastUpdate.delete(r),{modified:!1};else return{modified:!1};let a=nn(this._id),d=this._map.get(r);return isLiveNode(d)?(n=d._toOps(a,r),d._detach()):n=void 0===d?[{type:6,id:a,key:r}]:[{type:3,id:a,data:{[r]:d}}],this._map.set(r,s),this.invalidate(),isLiveStructure(s)&&(s._setParentLink(this,r),s._attach(i,this._pool)),{reverse:n,modified:{node:this,type:"LiveObject",updates:{[r]:{type:"update"}}}}}_detachChild(e){if(e){let t=nn(this._id),n=nn(e._parentKey),i=e._toOps(t,n,this._pool);for(let[t,n]of this._map)n===e&&(this._map.delete(t),this.invalidate());return e._detach(),{modified:{node:this,type:"LiveObject",updates:{[n]:{type:"delete"}}},reverse:i}}return{modified:!1}}_detach(){for(let e of(super._detach(),this._map.values()))isLiveNode(e)&&e._detach()}_apply(e,t){return 3===e.type?this._applyUpdate(e,t):6===e.type?this._applyDeleteObjectKey(e,t):super._apply(e,t)}_serialize(){let e={};for(let[t,n]of this._map)isLiveNode(n)||(e[t]=n);return"HasParent"===this.parent.type&&this.parent.node._id?{type:0,parentId:this.parent.node._id,parentKey:this.parent.key,data:e}:{type:0,data:e}}_applyUpdate(e,t){let n=!1,i=nn(this._id),o=[],r={type:3,id:i,data:{}};for(let t in e.data){let e=this._map.get(t);isLiveNode(e)?(o.push(...e._toOps(i,t)),e._detach()):void 0!==e?r.data[t]=e:void 0===e&&o.push({type:6,id:i,key:t})}let s={};for(let i in e.data){let o=e.data[i];if(void 0===o)continue;if(t)this._propToLastUpdate.set(i,nn(e.opId));else if(void 0===this._propToLastUpdate.get(i))n=!0;else{if(this._propToLastUpdate.get(i)!==e.opId)continue;this._propToLastUpdate.delete(i);continue}let r=this._map.get(i);isLiveNode(r)&&r._detach(),n=!0,s[i]={type:"update"},this._map.set(i,o),this.invalidate()}return 0!==Object.keys(r.data).length&&o.unshift(r),n?{modified:{node:this,type:"LiveObject",updates:s},reverse:o}:{modified:!1}}_applyDeleteObjectKey(e,t){let n=e.key;if(!1===this._map.has(n)||!t&&void 0!==this._propToLastUpdate.get(n))return{modified:!1};let i=this._map.get(n),o=nn(this._id),r=[];return isLiveNode(i)?(r=i._toOps(o,e.key),i._detach()):void 0!==i&&(r=[{type:3,id:o,data:{[n]:i}}]),this._map.delete(n),this.invalidate(),{modified:{node:this,type:"LiveObject",updates:{[e.key]:{type:"delete"}}},reverse:r}}toObject(){return Object.fromEntries(this._map)}set(e,t){this._pool?.assertStorageIsWritable(),this.update({[e]:t})}get(e){return this._map.get(e)}delete(e){let t;this._pool?.assertStorageIsWritable();let n=this._map.get(e);if(void 0===n)return;if(void 0===this._pool||void 0===this._id){isLiveNode(n)&&n._detach(),this._map.delete(e),this.invalidate();return}isLiveNode(n)?(n._detach(),t=n._toOps(this._id,e)):t=[{type:3,data:{[e]:n},id:this._id}],this._map.delete(e),this.invalidate();let i=new Map;i.set(this._id,{node:this,type:"LiveObject",updates:{[e]:{type:"delete"}}}),this._pool.dispatch([{type:6,key:e,id:this._id,opId:this._pool.generateOpId()}],t,i)}update(e){if(this._pool?.assertStorageIsWritable(),void 0===this._pool||void 0===this._id){for(let t in e){let n=e[t];if(void 0===n)continue;let i=this._map.get(t);isLiveNode(i)&&i._detach(),isLiveNode(n)&&n._setParentLink(this,t),this._map.set(t,n),this.invalidate()}return}let t=[],n=[],i=this._pool.generateOpId(),o={},r={id:this._id,type:3,data:{}},s={};for(let a in e){let d=e[a];if(void 0===d)continue;let c=this._map.get(a);if(isLiveNode(c)?(n.push(...c._toOps(this._id,a)),c._detach()):void 0===c?n.push({type:6,id:this._id,key:a}):r.data[a]=c,isLiveNode(d)){d._setParentLink(this,a),d._attach(this._pool.generateId(),this._pool);let e=d._toOps(this._id,a,this._pool),n=e.find(e=>e.parentId===this._id);n&&this._propToLastUpdate.set(a,nn(n.opId)),t.push(...e)}else o[a]=d,this._propToLastUpdate.set(a,i);this._map.set(a,d),this.invalidate(),s[a]={type:"update"}}0!==Object.keys(r.data).length&&n.unshift(r),0!==Object.keys(o).length&&t.unshift({opId:i,id:this._id,type:3,data:o});let a=new Map;a.set(this._id,{node:this,type:"LiveObject",updates:s}),this._pool.dispatch(t,n,a)}toImmutable(){return super.toImmutable()}toTreeNode(e){return super.toTreeNode(e)}_toTreeNode(e){let t=this._id??nanoid();return{type:"LiveObject",id:t,key:e,payload:Array.from(this._map.entries()).map(([e,n])=>isLiveNode(n)?n.toTreeNode(e):{type:"Json",id:`${t}:${e}`,key:e,payload:n})}}_toImmutable(){let e={};for(let[t,n]of this._map)e[t]=isLiveStructure(n)?n.toImmutable():n;return e}clone(){return new _LiveObject(Object.fromEntries(Array.from(this._map).map(([e,t])=>[e,isLiveStructure(t)?t.clone():deepClone(t)])))}};function creationOpToLiveNode(e){return lsonToLiveNode(creationOpToLson(e))}function creationOpToLson(e){switch(e.type){case 8:return e.data;case 4:return new W(e.data);case 7:return new F;case 2:return new z;default:return assertNever(e,"Unknown creation Op")}}function isSameNodeOrChildOf(e,t){return e===t||"HasParent"===e.parent.type&&isSameNodeOrChildOf(e.parent.node,t)}function deserialize([e,t],n,i){switch(t.type){case 0:return W._deserialize([e,t],n,i);case 1:return z._deserialize([e,t],n,i);case 2:return F._deserialize([e,t],n,i);case 3:return H._deserialize([e,t],n,i);default:throw Error("Unexpected CRDT type")}}function deserializeToLson([e,t],n,i){switch(t.type){case 0:return W._deserialize([e,t],n,i);case 1:return z._deserialize([e,t],n,i);case 2:return F._deserialize([e,t],n,i);case 3:return t.data;default:throw Error("Unexpected CRDT type")}}function isLiveStructure(e){return isLiveList(e)||isLiveMap(e)||isLiveObject(e)}function isLiveNode(e){return isLiveStructure(e)||isLiveRegister(e)}function isLiveList(e){return e instanceof z}function isLiveMap(e){return e instanceof F}function isLiveObject(e){return e instanceof W}function isLiveRegister(e){return e instanceof H}function cloneLson(e){return void 0===e?void 0:isLiveStructure(e)?e.clone():deepClone(e)}function liveNodeToLson(e){return e instanceof H?e.data:e instanceof z||e instanceof F||e instanceof W?e:assertNever(e,"Unknown AbstractCrdt")}function lsonToLiveNode(e){return e instanceof W||e instanceof F||e instanceof z?e:new H(e)}function getTreesDiffOperations(e,t){let n=[];return e.forEach((e,i)=>{t.get(i)||n.push({type:5,id:i})}),t.forEach((t,i)=>{let o=e.get(i);if(o)0===t.type&&(0!==o.type||JSON.stringify(t.data)!==JSON.stringify(o.data))&&n.push({type:3,id:i,data:t.data}),t.parentKey!==o.parentKey&&n.push({type:1,id:i,parentKey:nn(t.parentKey,"Parent key must not be missing")});else switch(t.type){case 3:n.push({type:8,id:i,parentId:t.parentId,parentKey:t.parentKey,data:t.data});break;case 1:n.push({type:2,id:i,parentId:t.parentId,parentKey:t.parentKey});break;case 0:if(void 0===t.parentId||void 0===t.parentKey)throw Error("Internal error. Cannot serialize storage root into an operation");n.push({type:4,id:i,parentId:t.parentId,parentKey:t.parentKey,data:t.data});break;case 2:n.push({type:7,id:i,parentId:t.parentId,parentKey:t.parentKey})}}),n}function mergeObjectStorageUpdates(e,t){let n=e.updates;for(let[e,i]of entries(t.updates))n[e]=i;return{...t,updates:n}}function mergeMapStorageUpdates(e,t){let n=e.updates;for(let[e,i]of entries(t.updates))n[e]=i;return{...t,updates:n}}function mergeListStorageUpdates(e,t){let n=e.updates;return{...t,updates:n.concat(t.updates)}}function mergeStorageUpdates(e,t){return void 0===e?t:"LiveObject"===e.type&&"LiveObject"===t.type?mergeObjectStorageUpdates(e,t):"LiveMap"===e.type&&"LiveMap"===t.type?mergeMapStorageUpdates(e,t):"LiveList"===e.type&&"LiveList"===t.type?mergeListStorageUpdates(e,t):t}function isJsonScalar(e){return null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function isJsonArray(e){return Array.isArray(e)}function isJsonObject(e){return!isJsonScalar(e)&&!isJsonArray(e)}var V=((a=V||{})[a.UPDATE_PRESENCE=100]="UPDATE_PRESENCE",a[a.BROADCAST_EVENT=103]="BROADCAST_EVENT",a[a.FETCH_STORAGE=200]="FETCH_STORAGE",a[a.UPDATE_STORAGE=201]="UPDATE_STORAGE",a[a.FETCH_YDOC=300]="FETCH_YDOC",a[a.UPDATE_YDOC=301]="UPDATE_YDOC",a);function merge(e,t){let n=!1,i={...e};return Object.keys(t).forEach(e=>{let o=t[e];i[e]!==o&&(void 0===o?delete i[e]:i[e]=o,n=!0)}),n?i:e}var q=class{constructor(){this._ev=makeEventSource()}get didInvalidate(){return this._ev.observable}invalidate(){void 0!==this._cache&&(this._cache=void 0,this._ev.notify())}get current(){return this._cache??(this._cache=this._toImmutable())}};function makeUser(e,t){let{connectionId:n,id:i,info:o}=e,r=canWriteStorage(e.scopes);return freeze(compactObject({connectionId:n,id:i,info:o,canWrite:r,canComment:canComment(e.scopes),isReadOnly:!r,presence:t}))}var G=class extends q{constructor(){super(),this._connections=new Map,this._presences=new Map,this._users=new Map}connectionIds(){return this._connections.keys()}_toImmutable(){let e=compact(Array.from(this._presences.keys()).map(e=>this.getUser(Number(e))));return e}clearOthers(){this._connections=new Map,this._presences=new Map,this._users=new Map,this.invalidate()}_getUser(e){let t=this._connections.get(e),n=this._presences.get(e);if(void 0!==t&&void 0!==n)return makeUser(t,n)}getUser(e){let t=this._users.get(e);if(t)return t;let n=this._getUser(e);if(n)return this._users.set(e,n),n}_invalidateUser(e){this._users.has(e)&&this._users.delete(e),this.invalidate()}setConnection(e,t,n,i){this._connections.set(e,freeze({connectionId:e,id:t,info:n,scopes:i})),this._presences.has(e)&&this._invalidateUser(e)}removeConnection(e){this._connections.delete(e),this._presences.delete(e),this._invalidateUser(e)}setOther(e,t){this._presences.set(e,freeze(compactObject(t))),this._connections.has(e)&&this._invalidateUser(e)}patchOther(e,t){let n=this._presences.get(e);if(void 0===n)return;let i=merge(n,t);n!==i&&(this._presences.set(e,freeze(i)),this._invalidateUser(e))}},Y=class extends q{constructor(e){super(),this._data=freeze(compactObject(e))}_toImmutable(){return this._data}patch(e){let t=this._data,n=merge(t,e);t!==n&&(this._data=freeze(n),this.invalidate())}},X=class extends q{constructor(e){super(),this._value=freeze(e)}_toImmutable(){return this._value}set(e){this._value=freeze(e),this.invalidate()}},Z=class extends q{constructor(...e){super();let t=e.pop();this._refs=e,this._refs.forEach(e=>{e.didInvalidate.subscribe(()=>this.invalidate())}),this._transform=t}_toImmutable(){return this._transform(...this._refs.map(e=>e.current))}};function makeIdFactory(e){let t=0;return()=>`${e}:${t++}`}function userToTreeNode(e,t){return{type:"User",id:`${t.connectionId}`,key:e,payload:t}}function installBackgroundTabSpy(){let e="undefined"!=typeof document?document:void 0,t={current:null};function onVisibilityChange(){e?.visibilityState==="hidden"?t.current=t.current??Date.now():t.current=null}return e?.addEventListener("visibilitychange",onVisibilityChange),[t,()=>{e?.removeEventListener("visibilitychange",onVisibilityChange)}]}var Q=class extends Error{constructor(e,t,n){super(e),this.message=e,this.status=t,this.details=n}};function createCommentsApi(e,t,n){async function fetchCommentsApi(i,o,r){let s=await t();return n(e,i,s,r,o)}async function fetchJson(e,t,n){let i;let o=await fetchCommentsApi(e,n,t);if(!o.ok&&o.status>=400&&o.status<600){let e;try{let t=await o.json();e=new Q(t.message,o.status,t)}catch{e=new Q(o.statusText,o.status)}throw e}try{i=await o.json()}catch{i={}}return i}return{getThreads:async function(e){let t=await fetchCommentsApi("/threads/search",{since:e?.since?.toISOString()},{body:JSON.stringify({...e?.query?.metadata&&{metadata:e.query.metadata}}),headers:{"Content-Type":"application/json"},method:"POST"});if(t.ok){let e=await t.json();return{threads:e.data.map(e=>convertToThreadData(e)),inboxNotifications:e.inboxNotifications.map(e=>convertToInboxNotificationData(e)),deletedThreads:e.deletedThreads.map(e=>convertToThreadDeleteInfo(e)),deletedInboxNotifications:e.deletedInboxNotifications.map(e=>convertToInboxNotificationDeleteInfo(e)),meta:{requestedAt:new Date(e.meta.requestedAt)}}}if(404===t.status)return{threads:[],inboxNotifications:[],deletedThreads:[],deletedInboxNotifications:[],meta:{requestedAt:new Date}};throw Error("There was an error while getting threads.")},getThread:async function({threadId:e}){let t=await fetchCommentsApi(`/thread-with-notification/${e}`);if(t.ok){let e=await t.json();return{thread:convertToThreadData(e.thread),inboxNotification:e.inboxNotification?convertToInboxNotificationData(e.inboxNotification):void 0}}if(404!==t.status)throw Error(`There was an error while getting thread ${e}.`)},createThread:async function({metadata:e,body:t,commentId:n,threadId:i}){let o=await fetchJson("/threads",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:i,comment:{id:n,body:t},metadata:e})});return convertToThreadData(o)},editThreadMetadata:async function({metadata:e,threadId:t}){return await fetchJson(`/threads/${encodeURIComponent(t)}/metadata`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})},createComment:async function({threadId:e,commentId:t,body:n}){let i=await fetchJson(`/threads/${encodeURIComponent(e)}/comments`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t,body:n})});return convertToCommentData(i)},editComment:async function({threadId:e,commentId:t,body:n}){let i=await fetchJson(`/threads/${encodeURIComponent(e)}/comments/${encodeURIComponent(t)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({body:n})});return convertToCommentData(i)},deleteComment:async function({threadId:e,commentId:t}){await fetchJson(`/threads/${encodeURIComponent(e)}/comments/${encodeURIComponent(t)}`,{method:"DELETE"})},addReaction:async function({threadId:e,commentId:t,emoji:n}){let i=await fetchJson(`/threads/${encodeURIComponent(e)}/comments/${encodeURIComponent(t)}/reactions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({emoji:n})});return convertToCommentUserReaction(i)},removeReaction:async function({threadId:e,commentId:t,emoji:n}){await fetchJson(`/threads/${encodeURIComponent(e)}/comments/${encodeURIComponent(t)}/reactions/${encodeURIComponent(n)}`,{method:"DELETE"})}}}function createRoom(e,t){let n,i,o;let r="function"==typeof e.initialPresence?e.initialPresence(t.roomId):e.initialPresence,s="function"==typeof e.initialStorage?e.initialStorage(t.roomId):e.initialStorage,[a,d]=installBackgroundTabSpy(),c={...t.delegates,canZombie:()=>void 0!==t.backgroundKeepAliveTimeout&&null!==a.current&&Date.now()>a.current+t.backgroundKeepAliveTimeout&&"synchronizing"!==getStorageStatus()},l=new C(c,t.enableDebugLogging),u={buffer:{flushTimerID:void 0,lastFlushedAt:0,presenceUpdates:{type:"full",data:r},messages:[],storageOperations:[]},staticSessionInfo:new X(null),dynamicSessionInfo:new X(null),myPresence:new Y(r),others:new G,initialStorage:s,idFactory:null,clock:0,opClock:0,nodes:new Map,root:void 0,undoStack:[],redoStack:[],pausedHistory:null,activeBatch:null,unacknowledgedOps:new Map,opStackTraces:void 0},doNotBatchUpdates=e=>e(),h=t.unstable_batchedUpdates??doNotBatchUpdates;function onStatusDidChange(e){let t=l.authValue;if(null!==t){let e=getAuthBearerHeaderFromAuthValue(t);if(e!==n){if(n=e,"secret"===t.type){let e=t.token.parsed;u.staticSessionInfo.set({userId:"sec-legacy"===e.k?e.id:e.uid,userInfo:"sec-legacy"===e.k?e.info:e.ui})}else u.staticSessionInfo.set({userId:void 0,userInfo:void 0})}}h(()=>{_.status.notify(e),notifySelfChanged(doNotBatchUpdates)})}let p=!1;function handleConnectionLossEvent(e){"reconnecting"===e?i=setTimeout(()=>{h(()=>{_.lostConnection.notify("lost"),p=!0,u.others.clearOthers(),notify({others:[{type:"reset"}]},doNotBatchUpdates)})},t.lostConnectionTimeout):(clearTimeout(i),p&&("disconnected"===e?h(()=>{_.lostConnection.notify("failed")}):h(()=>{_.lostConnection.notify("restored")}),p=!1))}function onDidConnect(){u.buffer.presenceUpdates={type:"full",data:{...u.myPresence.current}},null!==b&&refreshStorage({flush:!1}),flushNowOrSoon()}function onDidDisconnect(){clearTimeout(u.buffer.flushTimerID)}l.events.onMessage.subscribe(handleServerMessage),l.events.statusDidChange.subscribe(onStatusDidChange),l.events.statusDidChange.subscribe(handleConnectionLossEvent),l.events.didConnect.subscribe(onDidConnect),l.events.didDisconnect.subscribe(onDidDisconnect),l.events.onLiveblocksError.subscribe(e=>{h(()=>{_.error.notify(e)})});let m={roomId:t.roomId,getNode:e=>u.nodes.get(e),addNode:(e,t)=>void u.nodes.set(e,t),deleteNode:e=>void u.nodes.delete(e),generateId:()=>`${getConnectionId()}:${u.clock++}`,generateOpId:()=>`${getConnectionId()}:${u.opClock++}`,dispatch(e,t,n){let i=u.activeBatch;if(i){for(let[t,o]of(i.ops.push(...e),n))i.updates.storageUpdates.set(t,mergeStorageUpdates(i.updates.storageUpdates.get(t),o));i.reverseOps.unshift(...t)}else h(()=>{addToUndoStack(t,doNotBatchUpdates),u.redoStack.length=0,dispatchOps(e),notify({storageUpdates:n},doNotBatchUpdates)})},assertStorageIsWritable:()=>{let e=u.dynamicSessionInfo.current?.scopes;if(void 0===e)return;let t=canWriteStorage(e);if(!t)throw Error("Cannot write to storage with a read only user, please ensure the user has write permissions")}},_={connection:makeEventSource(),status:makeEventSource(),lostConnection:makeEventSource(),customEvent:makeEventSource(),self:makeEventSource(),myPresence:makeEventSource(),others:makeEventSource(),error:makeEventSource(),storage:makeEventSource(),history:makeEventSource(),storageDidLoad:makeEventSource(),storageStatus:makeEventSource(),ydoc:makeEventSource(),comments:makeEventSource()};async function fetchClientApi(e,n,i,o,r){let s=urljoin(t.baseUrl,`/v2/c/rooms/${encodeURIComponent(e)}${n}`,r),a=t.polyfills?.fetch||fetch;return await a(s,{...o,headers:{...o?.headers,Authorization:`Bearer ${getAuthBearerHeaderFromAuthValue(i)}`}})}async function streamFetch(e,t){return fetchClientApi(t,"/storage",e,{method:"GET",headers:{"Content-Type":"application/json"}})}async function httpPostToRoom(e,n){if(!l.authValue)throw Error("Not authorized");return fetchClientApi(t.roomId,e,l.authValue,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}function sendMessages(e){let n=JSON.stringify(e),i=u.dynamicSessionInfo.current?.nonce;if(t.unstable_fallbackToHTTP&&i){let t=new TextEncoder().encode(n).length;if(t>1047552){httpPostToRoom("/send-message",{nonce:i,messages:e}).then(e=>{e.ok||403!==e.status||l.reconnect()}),f("Message was too large for websockets and sent over HTTP instead");return}}l.send(n)}let g=new Z(u.staticSessionInfo,u.dynamicSessionInfo,u.myPresence,(e,t,n)=>{if(null===e||null===t)return null;{let i=canWriteStorage(t.scopes);return{connectionId:t.actor,id:e.userId,info:e.userInfo,presence:n,canWrite:i,canComment:canComment(t.scopes),isReadOnly:!i}}});function notifySelfChanged(e){let t=g.current;null!==t&&t!==o&&(e(()=>{_.self.notify(t)}),o=t)}let v=new Z(g,e=>null!==e?userToTreeNode("Me",e):null);function createOrUpdateRootFromMessage(e,t){if(0===e.items.length)throw Error("Internal error: cannot load storage without items");void 0!==u.root?updateRoot(e.items,t):u.root=W._fromItems(e.items,m);let n=u.undoStack.length;for(let e in u.initialStorage)void 0===u.root.get(e)&&u.root.set(e,cloneLson(u.initialStorage[e]));u.undoStack.length=n}function updateRoot(e,t){if(void 0===u.root)return;let n=new Map;for(let[e,t]of u.nodes)n.set(e,t._serialize());let i=getTreesDiffOperations(n,new Map(e)),o=applyOps(i,!1);notify(o.updates,t)}function _addToRealUndoStack(e,t){u.undoStack.length>=50&&u.undoStack.shift(),u.undoStack.push(e),onHistoryChange(t)}function addToUndoStack(e,t){null!==u.pausedHistory?u.pausedHistory.unshift(...e):_addToRealUndoStack(e,t)}function notify(e,t){let n=e.storageUpdates,i=e.others;t(()=>{if(void 0!==i&&i.length>0){let e=u.others.current;for(let t of i)_.others.notify({...t,others:e})}if(e.presence&&(notifySelfChanged(doNotBatchUpdates),_.myPresence.notify(u.myPresence.current)),void 0!==n&&n.size>0){let e=Array.from(n.values());_.storage.notify(e)}notifyStorageStatus()})}function getConnectionId(){let e=u.dynamicSessionInfo.current;if(e)return e.actor;throw Error("Internal. Tried to get connection id but connection was never open")}function applyOps(e,t){let n={reverse:[],storageUpdates:new Map,presence:!1},i=new Set,o=e.map(e=>"presence"===e.type||e.opId?e:{...e,opId:m.generateOpId()});for(let e of o)if("presence"===e.type){let t={type:"presence",data:{}};for(let n in e.data)t.data[n]=u.myPresence.current[n];if(u.myPresence.patch(e.data),null===u.buffer.presenceUpdates)u.buffer.presenceUpdates={type:"partial",data:e.data};else for(let t in e.data)u.buffer.presenceUpdates.data[t]=e.data[t];n.reverse.unshift(t),n.presence=!0}else{let o;if(t)o=0;else{let t=nn(e.opId),n=u.unacknowledgedOps.delete(t);o=n?2:1}let r=applyOp(e,o);if(r.modified){let t=r.modified.node._id;t&&i.has(t)||(n.storageUpdates.set(nn(r.modified.node._id),mergeStorageUpdates(n.storageUpdates.get(nn(r.modified.node._id)),r.modified)),n.reverse.unshift(...r.reverse)),(2===e.type||7===e.type||4===e.type)&&i.add(nn(e.id))}}return{ops:o,reverse:n.reverse,updates:{storageUpdates:n.storageUpdates,presence:n.presence}}}function applyOp(e,t){if(isAckOp(e))return{modified:!1};switch(e.type){case 6:case 3:case 5:{let n=u.nodes.get(e.id);if(void 0===n)return{modified:!1};return n._apply(e,0===t)}case 1:{let n=u.nodes.get(e.id);if(void 0===n)return{modified:!1};if("HasParent"===n.parent.type&&isLiveList(n.parent.node))return n.parent.node._setChildKey(asPos(e.parentKey),n,t);return{modified:!1}}case 4:case 2:case 7:case 8:{if(void 0===e.parentId)return{modified:!1};let n=u.nodes.get(e.parentId);if(void 0===n)return{modified:!1};return n._attachChild(e,t)}}}function updatePresence(e,t){let n={};for(let t in null===u.buffer.presenceUpdates&&(u.buffer.presenceUpdates={type:"partial",data:{}}),e){let i=e[t];void 0!==i&&(u.buffer.presenceUpdates.data[t]=i,n[t]=u.myPresence.current[t])}u.myPresence.patch(e),u.activeBatch?(t?.addToHistory&&u.activeBatch.reverseOps.unshift({type:"presence",data:n}),u.activeBatch.updates.presence=!0):(flushNowOrSoon(),h(()=>{t?.addToHistory&&addToUndoStack([{type:"presence",data:n}],doNotBatchUpdates),notify({presence:!0},doNotBatchUpdates)}))}function onUpdatePresenceMessage(e){if(void 0!==e.targetActor){let t=u.others.getUser(e.actor);u.others.setOther(e.actor,e.data);let n=u.others.getUser(e.actor);if(void 0===t&&void 0!==n)return{type:"enter",user:n}}else u.others.patchOther(e.actor,e.data);let t=u.others.getUser(e.actor);return t?{type:"update",updates:e.data,user:t}:void 0}function onUserLeftMessage(e){let t=u.others.getUser(e.actor);return t?(u.others.removeConnection(e.actor),{type:"leave",user:t}):null}function onRoomStateMessage(e,t){for(let n of(u.dynamicSessionInfo.set({actor:e.actor,nonce:e.nonce,scopes:e.scopes}),u.idFactory=makeIdFactory(e.actor),notifySelfChanged(t),u.others.connectionIds())){let t=e.users[n];void 0===t&&u.others.removeConnection(n)}for(let t in e.users){let n=e.users[t],i=Number(t);u.others.setConnection(i,n.id,n.info,n.scopes)}return{type:"reset"}}function canUndo(){return u.undoStack.length>0}function canRedo(){return u.redoStack.length>0}function onHistoryChange(e){e(()=>{_.history.notify({canUndo:canUndo(),canRedo:canRedo()})})}function onUserJoinedMessage(e){u.others.setConnection(e.actor,e.id,e.info,e.scopes),u.buffer.messages.push({type:100,data:u.myPresence.current,targetActor:e.actor}),flushNowOrSoon();let t=u.others.getUser(e.actor);return t?{type:"enter",user:t}:void 0}function parseServerMessages(e){let t=tryParseJson(e);return void 0===t?null:isJsonArray(t)?compact(t.map(e=>isJsonObject(e)?e:null)):compact([isJsonObject(t)?t:null])}function applyAndSendOps(e,t){if(0===e.size)return;let n=[],i=Array.from(e.values()),o=applyOps(i,!0);n.push({type:201,ops:o.ops}),notify(o.updates,t),sendMessages(n)}function handleServerMessage(e){if("string"!=typeof e.data)return;let t=parseServerMessages(e.data);if(null===t||0===t.length)return;let n={storageUpdates:new Map,others:[]};h(()=>{for(let e of t)switch(e.type){case 101:{let t=onUserJoinedMessage(e);t&&n.others.push(t);break}case 100:{let t=onUpdatePresenceMessage(e);t&&n.others.push(t);break}case 103:{let t=u.others.current;_.customEvent.notify({connectionId:e.actor,user:e.actor<0?null:t.find(t=>t.connectionId===e.actor)??null,event:e.event});break}case 102:{let t=onUserLeftMessage(e);t&&n.others.push(t);break}case 300:_.ydoc.notify(e);break;case 104:n.others.push(onRoomStateMessage(e,doNotBatchUpdates));break;case 200:processInitialStorage(e);break;case 201:{let t=applyOps(e.ops,!1);for(let[e,i]of t.updates.storageUpdates)n.storageUpdates.set(e,mergeStorageUpdates(n.storageUpdates.get(e),i));break}case 299:y("Storage mutation rejection error",e.reason);break;case 400:case 401:case 405:case 406:case 402:case 403:case 404:_.comments.notify(e)}notify(n,doNotBatchUpdates)})}function flushNowOrSoon(){let e=u.buffer.storageOperations;if(e.length>0){for(let t of e)u.unacknowledgedOps.set(nn(t.opId),t);notifyStorageStatus()}if("connected"!==l.getStatus()){u.buffer.storageOperations=[];return}let n=Date.now(),i=n-u.buffer.lastFlushedAt;if(i>=t.throttleDelay){let e=serializeBuffer();if(0===e.length)return;sendMessages(e),u.buffer={flushTimerID:void 0,lastFlushedAt:n,messages:[],storageOperations:[],presenceUpdates:null}}else clearTimeout(u.buffer.flushTimerID),u.buffer.flushTimerID=setTimeout(flushNowOrSoon,t.throttleDelay-i)}function serializeBuffer(){let e=[];for(let t of(u.buffer.presenceUpdates&&e.push("full"===u.buffer.presenceUpdates.type?{type:100,targetActor:-1,data:u.buffer.presenceUpdates.data}:{type:100,data:u.buffer.presenceUpdates.data}),u.buffer.messages))e.push(t);return u.buffer.storageOperations.length>0&&e.push({type:201,ops:u.buffer.storageOperations}),e}function updateYDoc(e,t){let n={type:301,update:e,guid:t};u.buffer.messages.push(n),_.ydoc.notify(n),flushNowOrSoon()}function broadcastEvent(e,t={shouldQueueEventIfNotReady:!1}){("connected"===l.getStatus()||t.shouldQueueEventIfNotReady)&&(u.buffer.messages.push({type:103,event:e}),flushNowOrSoon())}function dispatchOps(e){u.buffer.storageOperations.push(...e),flushNowOrSoon()}let b=null,S=null;function processInitialStorage(e){let t=new Map(u.unacknowledgedOps);createOrUpdateRootFromMessage(e,doNotBatchUpdates),applyAndSendOps(t,doNotBatchUpdates),S?.(),notifyStorageStatus(),_.storageDidLoad.notify()}async function streamStorage(){if(!l.authValue)return;let e=await streamFetch(l.authValue,t.roomId),n=await e.json();processInitialStorage({type:200,items:n})}function refreshStorage(e){let n=u.buffer.messages;t.unstable_streamData?streamStorage():n.some(e=>200===e.type)||n.push({type:200}),e.flush&&flushNowOrSoon()}function startLoadingStorage(){return null===b&&(refreshStorage({flush:!0}),b=new Promise(e=>{S=e}),notifyStorageStatus()),b}function getStorageSnapshot(){let e=u.root;return void 0!==e?e:(startLoadingStorage(),null)}async function getStorage(){return void 0!==u.root?Promise.resolve({root:u.root}):(await startLoadingStorage(),{root:nn(u.root)})}function fetchYDoc(e,t){u.buffer.messages.find(n=>300===n.type&&n.vector===e&&n.guid===t)||u.buffer.messages.push({type:300,vector:e,guid:t}),flushNowOrSoon()}function undo(){if(u.activeBatch)throw Error("undo is not allowed during a batch");let e=u.undoStack.pop();if(void 0===e)return;u.pausedHistory=null;let t=applyOps(e,!0);for(let e of(h(()=>{notify(t.updates,doNotBatchUpdates),u.redoStack.push(t.reverse),onHistoryChange(doNotBatchUpdates)}),t.ops))"presence"!==e.type&&u.buffer.storageOperations.push(e);flushNowOrSoon()}function redo(){if(u.activeBatch)throw Error("redo is not allowed during a batch");let e=u.redoStack.pop();if(void 0===e)return;u.pausedHistory=null;let t=applyOps(e,!0);for(let e of(h(()=>{notify(t.updates,doNotBatchUpdates),u.undoStack.push(t.reverse),onHistoryChange(doNotBatchUpdates)}),t.ops))"presence"!==e.type&&u.buffer.storageOperations.push(e);flushNowOrSoon()}function clear(){u.undoStack.length=0,u.redoStack.length=0}function batch(e){let t;return u.activeBatch?e():(h(()=>{u.activeBatch={ops:[],updates:{storageUpdates:new Map,presence:!1,others:[]},reverseOps:[]};try{t=e()}finally{let e=u.activeBatch;u.activeBatch=null,e.reverseOps.length>0&&addToUndoStack(e.reverseOps,doNotBatchUpdates),e.ops.length>0&&(u.redoStack.length=0),e.ops.length>0&&dispatchOps(e.ops),notify(e.updates,doNotBatchUpdates),flushNowOrSoon()}}),t)}function pauseHistory(){null===u.pausedHistory&&(u.pausedHistory=[])}function resumeHistory(){let e=u.pausedHistory;u.pausedHistory=null,null!==e&&e.length>0&&_addToRealUndoStack(e,h)}function getStorageStatus(){return void 0===u.root?null===b?"not-loaded":"loading":0===u.unacknowledgedOps.size?"synchronized":"synchronizing"}let E=getStorageStatus();function notifyStorageStatus(){let e=getStorageStatus();E!==e&&(E=e,_.storageStatus.notify(e))}let T=new Z(u.others,e=>e.map((e,t)=>userToTreeNode(`Other ${t}`,e))),k={status:_.status.observable,lostConnection:_.lostConnection.observable,customEvent:_.customEvent.observable,others:_.others.observable,self:_.self.observable,myPresence:_.myPresence.observable,error:_.error.observable,storage:_.storage.observable,history:_.history.observable,storageDidLoad:_.storageDidLoad.observable,storageStatus:_.storageStatus.observable,ydoc:_.ydoc.observable,comments:_.comments.observable},w=createCommentsApi(t.roomId,c.authenticate,fetchClientApi);async function fetchNotificationsJson(e,n){let i;let o=await c.authenticate(),r=await fetchClientApi(t.roomId,e,o,n);if(!r.ok&&r.status>=400&&r.status<600){let e;try{let t=await r.json();e=new ee(t.message,r.status,t)}catch{e=new ee(r.statusText,r.status)}throw e}try{i=await r.json()}catch{i={}}return i}function getRoomNotificationSettings(){return fetchNotificationsJson("/notification-settings")}function updateRoomNotificationSettings(e){return fetchNotificationsJson("/notification-settings",{method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}})}async function markInboxNotificationsAsRead(e){await fetchNotificationsJson("/inbox-notifications/read",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inboxNotificationIds:e})})}let O=new R(async e=>{let t=e.flat();return await markInboxNotificationsAsRead(t),t},{delay:50});async function markInboxNotificationAsRead(e){await O.get(e)}return Object.defineProperty({[N]:{get presenceBuffer(){return deepClone(u.buffer.presenceUpdates?.data??null)},get undoStack(){return deepClone(u.undoStack)},get nodeCount(){return u.nodes.size},getSelf_forDevTools:()=>v.current,getOthers_forDevTools:()=>T.current,simulate:{explicitClose:e=>l._privateSendMachineEvent({type:"EXPLICIT_SOCKET_CLOSE",event:e}),rawSend:e=>l.send(e)},comments:{...w},notifications:{getRoomNotificationSettings,updateRoomNotificationSettings,markInboxNotificationAsRead}},id:t.roomId,subscribe:makeClassicSubscribeFn(k),connect:()=>l.connect(),reconnect:()=>l.reconnect(),disconnect:()=>l.disconnect(),destroy:()=>{d(),l.destroy()},updatePresence,updateYDoc,broadcastEvent,batch,history:{undo,redo,canUndo,canRedo,clear,pause:pauseHistory,resume:resumeHistory},fetchYDoc,getStorage,getStorageSnapshot,getStorageStatus,events:k,getStatus:()=>l.getStatus(),getConnectionState:()=>l.getLegacyStatus(),getSelf:()=>g.current,getPresence:()=>u.myPresence.current,getOthers:()=>u.others.current},N,{enumerable:!1})}function makeClassicSubscribeFn(e){function subscribeToLiveStructureDeeply(t,n){return e.storage.subscribe(e=>{let i=e.filter(e=>isSameNodeOrChildOf(e.node,t));i.length>0&&n(i)})}function subscribeToLiveStructureShallowly(t,n){return e.storage.subscribe(e=>{for(let i of e)i.node._id===t._id&&n(i.node)})}return function(t,n,i){if("string"==typeof t&&isRoomEventName(t)){if("function"!=typeof n)throw Error("Second argument must be a callback function");switch(t){case"event":return e.customEvent.subscribe(n);case"my-presence":return e.myPresence.subscribe(n);case"others":return e.others.subscribe(e=>{let{others:t,...i}=e;return n(t,i)});case"error":return e.error.subscribe(n);case"connection":return e.status.subscribe(e=>n(newToLegacyStatus(e)));case"status":return e.status.subscribe(n);case"lost-connection":return e.lostConnection.subscribe(n);case"history":return e.history.subscribe(n);case"storage-status":return e.storageStatus.subscribe(n);default:return assertNever(t,`"${String(t)}" is not a valid event name`)}}if(void 0===n||"function"==typeof t){if("function"==typeof t)return e.storage.subscribe(t);throw Error("Please specify a listener callback")}if(isLiveNode(t))return i?.isDeep?subscribeToLiveStructureDeeply(t,n):subscribeToLiveStructureShallowly(t,n);throw Error(`${String(t)} is not a value that can be subscribed to.`)}}function isRoomEventName(e){return"my-presence"===e||"others"===e||"event"===e||"error"===e||"history"===e||"status"===e||"storage-status"===e||"lost-connection"===e||"connection"===e}function makeAuthDelegateForRoom(e,t){return async()=>t.getAuthValue({requestedScope:"room:read",roomId:e})}function makeCreateSocketDelegateForRoom(e,t,n){return i=>{let o=n??("undefined"==typeof WebSocket?void 0:WebSocket);if(void 0===o)throw new O("To use Liveblocks client in a non-DOM environment, you need to provide a WebSocket polyfill.");let r=new URL(t);if(r.protocol="http:"===r.protocol?"ws":"wss",r.pathname="/v7",r.searchParams.set("roomId",e),"secret"===i.type)r.searchParams.set("tok",i.token.raw);else{if("public"!==i.type)return assertNever(i,"Unhandled case");r.searchParams.set("pubkey",i.publicApiKey)}return r.searchParams.set("version",l||"dev"),new o(r.toString())}}function createClientStore(){let e=createStore({threads:{},queries:{},optimisticUpdates:[],inboxNotifications:{},notificationSettings:{}});return{...e,deleteThread(t){e.set(e=>({...e,threads:deleteKeyImmutable(e.threads,t),inboxNotifications:Object.fromEntries(Object.entries(e.inboxNotifications).filter(([e,n])=>n.threadId!==t))}))},updateThreadAndNotification(t,n){e.set(e=>{let i=e.threads[t.id];return{...e,threads:void 0===i||1===compareThreads(t,i)?{...e.threads,[t.id]:t}:e.threads,inboxNotifications:void 0===n?e.inboxNotifications:{...e.inboxNotifications,[n.id]:n}}})},updateThreadsAndNotifications(t,n,i,o,r){e.set(e=>({...e,threads:applyThreadUpdates(e.threads,{newThreads:t,deletedThreads:i}),inboxNotifications:applyNotificationsUpdates(e.inboxNotifications,{newInboxNotifications:n,deletedNotifications:o}),queries:void 0!==r?{...e.queries,[r]:{isLoading:!1}}:e.queries}))},updateRoomInboxNotificationSettings(t,n,i){e.set(e=>({...e,notificationSettings:{...e.notificationSettings,[t]:n},queries:{...e.queries,[i]:{isLoading:!1}}}))},pushOptimisticUpdate(t){e.set(e=>({...e,optimisticUpdates:[...e.optimisticUpdates,t]}))},setQueryState(t,n){e.set(e=>({...e,queries:{...e.queries,[t]:n}}))}}}function deleteKeyImmutable(e,t){if(Object.prototype.hasOwnProperty.call(e,t)){let{[t]:n,...i}=e;return i}return e}function compareThreads(e,t){return e.updatedAt&&t.updatedAt?e.updatedAt>t.updatedAt?1:e.updatedAt<t.updatedAt?-1:0:e.updatedAt||t.updatedAt?e.updatedAt?1:-1:e.createdAt>t.createdAt?1:e.createdAt<t.createdAt?-1:0}function applyOptimisticUpdates(e){let t={threads:{...e.threads},inboxNotifications:{...e.inboxNotifications},notificationSettings:{...e.notificationSettings}};for(let n of e.optimisticUpdates)switch(n.type){case"create-thread":t.threads[n.thread.id]=n.thread;break;case"edit-thread-metadata":{let e=t.threads[n.threadId];if(void 0===e||void 0!==e.deletedAt||void 0!==e.updatedAt&&e.updatedAt>n.updatedAt)break;t.threads[e.id]={...e,updatedAt:n.updatedAt,metadata:{...e.metadata,...n.metadata}};break}case"create-comment":{let e=t.threads[n.comment.threadId];if(void 0===e)break;t.threads[e.id]=upsertComment(e,n.comment);let i=Object.values(t.inboxNotifications).find(t=>t.threadId===e.id);if(void 0===i)break;t.inboxNotifications[i.id]={...i,notifiedAt:n.comment.createdAt,readAt:n.comment.createdAt};break}case"edit-comment":{let e=t.threads[n.comment.threadId];if(void 0===e)break;t.threads[e.id]=upsertComment(e,n.comment);break}case"delete-comment":{let e=t.threads[n.threadId];if(void 0===e)break;t.threads[e.id]=deleteComment(e,n.commentId,n.deletedAt);break}case"add-reaction":{let e=t.threads[n.threadId];if(void 0===e)break;t.threads[e.id]=addReaction(e,n.commentId,n.reaction);break}case"remove-reaction":{let e=t.threads[n.threadId];if(void 0===e)break;t.threads[e.id]=removeReaction(e,n.commentId,n.emoji,n.userId,n.removedAt);break}case"mark-inbox-notification-as-read":t.inboxNotifications[n.inboxNotificationId]={...e.inboxNotifications[n.inboxNotificationId],readAt:n.readAt};break;case"mark-inbox-notifications-as-read":for(let e in t.inboxNotifications)t.inboxNotifications[e]={...t.inboxNotifications[e],readAt:n.readAt};break;case"update-notification-settings":t.notificationSettings[n.roomId]={...t.notificationSettings[n.roomId],...n.settings}}return t}function applyThreadUpdates(e,t){let n={...e};return t.newThreads.forEach(e=>{let t=n[e.id];if(t){let n=compareThreads(t,e);if(1===n)return}n[e.id]=e}),t.deletedThreads.forEach(({id:e,deletedAt:t})=>{let i=n[e];void 0!==i&&(i.deletedAt=t,i.updatedAt=t,i.comments=[])}),n}function applyNotificationsUpdates(e,t){let n={...e};return t.newInboxNotifications.forEach(e=>{let t=n[e.id];if(t){let n=compareInboxNotifications(t,e);if(1===n)return}n[e.id]=e}),t.deletedNotifications.forEach(({id:e})=>delete n[e]),n}function compareInboxNotifications(e,t){return e.notifiedAt>t.notifiedAt?1:e.notifiedAt<t.notifiedAt?-1:e.readAt&&t.readAt?e.readAt>t.readAt?1:e.readAt<t.readAt?-1:0:e.readAt||t.readAt?e.readAt?1:-1:0}function upsertComment(e,t){if(void 0!==e.deletedAt)return e;if(t.threadId!==e.id)return f(`Comment ${t.id} does not belong to thread ${e.id}`),e;let n=e.comments.find(e=>e.id===t.id);if(void 0===n){let n=new Date(Math.max(e.updatedAt?.getTime()||0,t.createdAt.getTime())),i={...e,updatedAt:n,comments:[...e.comments,t]};return i}if(void 0!==n.deletedAt)return e;if(void 0===n.editedAt||void 0===t.editedAt||n.editedAt<=t.editedAt){let n=e.comments.map(e=>e.id===t.id?t:e),i={...e,updatedAt:new Date(Math.max(e.updatedAt?.getTime()||0,t.editedAt?.getTime()||t.createdAt.getTime())),comments:n};return i}return e}function deleteComment(e,t,n){if(void 0!==e.deletedAt)return e;let i=e.comments.find(e=>e.id===t);if(void 0===i||void 0!==i.deletedAt)return e;let o=e.comments.map(e=>e.id===t?{...e,deletedAt:n,body:void 0}:e);return o.some(e=>void 0===e.deletedAt)?{...e,updatedAt:n,comments:o}:{...e,deletedAt:n,updatedAt:n,comments:[]}}function addReaction(e,t,n){if(void 0!==e.deletedAt)return e;let i=e.comments.find(e=>e.id===t);if(void 0===i||void 0!==i.deletedAt)return e;let o=e.comments.map(e=>e.id===t?{...e,reactions:upsertReaction(e.reactions,n)}:e);return{...e,updatedAt:new Date(Math.max(n.createdAt.getTime(),e.updatedAt?.getTime()||0)),comments:o}}function removeReaction(e,t,n,i,o){if(void 0!==e.deletedAt)return e;let r=e.comments.find(e=>e.id===t);if(void 0===r||void 0!==r.deletedAt)return e;let s=e.comments.map(e=>e.id===t?{...e,reactions:e.reactions.map(e=>e.emoji===n?{...e,users:e.users.filter(e=>e.id!==i)}:e).filter(e=>e.users.length>0)}:e);return{...e,updatedAt:new Date(Math.max(o.getTime(),e.updatedAt?.getTime()||0)),comments:s}}function upsertReaction(e,t){let n=e.find(e=>e.emoji===t.emoji);return void 0===n?[...e,{emoji:t.emoji,createdAt:t.createdAt,users:[{id:t.userId}]}]:!1===n.users.some(e=>e.id===t.userId)?e.map(e=>e.emoji===t.emoji?{...e,users:[...e.users,{id:t.userId}]}:e):e}function getBaseUrl(e){return"string"==typeof e&&e.startsWith("http")?e:"https://api.liveblocks.io"}function getAuthBearerHeaderFromAuthValue(e){return"public"===e.type?e.publicApiKey:e.token.raw}function createClient(e){let t=getThrottle(e.throttle??100),n=getLostConnectionTimeout(e.lostConnectionTimeout??5e3),i=getBackgroundKeepAliveTimeout(e.backgroundKeepAliveTimeout),o=getBaseUrl(e.baseUrl),r=createAuthManager(e),s=new Map;function teardownRoom(e){e.id,s.delete(e.id),e.destroy()}function leaseRoom(e){let leave=()=>{e.unsubs.delete(leave)?0===e.unsubs.size&&teardownRoom(e.room):f("This leave function was already called. Calling it more than once has no effect.")};return e.unsubs.add(leave),{room:e.room,leave}}function enterRoom(a,d){let c=s.get(a);if(void 0!==c)return leaseRoom(c);null===d.initialPresence||d.initialPresence;let l=createRoom({initialPresence:d.initialPresence??{},initialStorage:d.initialStorage},{roomId:a,throttleDelay:t,lostConnectionTimeout:n,backgroundKeepAliveTimeout:i,polyfills:e.polyfills,delegates:e.mockedDelegates??{createSocket:makeCreateSocketDelegateForRoom(a,o,e.polyfills?.WebSocket),authenticate:makeAuthDelegateForRoom(a,r)},enableDebugLogging:e.enableDebugLogging,unstable_batchedUpdates:d?.unstable_batchedUpdates,baseUrl:o,unstable_fallbackToHTTP:!!e.unstable_fallbackToHTTP,unstable_streamData:!!e.unstable_streamData}),u={room:l,unsubs:new Set};s.set(a,u),()=>Array.from(s.keys());let h=d.autoConnect??d.shouldInitiallyConnect??!0;if(h){if("undefined"==typeof atob){if(e.polyfills?.atob===void 0)throw Error("You need to polyfill atob to use the client in your environment. Please follow the instructions at https://liveblocks.io/docs/errors/liveblocks-client/atob-polyfill");global.atob=e.polyfills.atob}l.connect()}return leaseRoom(u)}function enter(e,t){let{room:n,leave:i}=enterRoom(e,t);return n}function getRoom(e){let t=s.get(e)?.room;return t||null}function forceLeave(e){let t=s.get(e)?.unsubs??new Set;for(let e of t)e()}function logout(){for(let{room:e}of(r.reset(),s.values()))isIdle(e.getStatus())||e.reconnect()}let a=createStore(null),{getInboxNotifications:d,getUnreadInboxNotificationsCount:c,markAllInboxNotificationsAsRead:l,markInboxNotificationAsRead:u}=createNotificationsApi({baseUrl:o,fetcher:e.polyfills?.fetch||fetch,authManager:r,currentUserIdStore:a}),h=createClientStore(),p=e.resolveUsers,m=createDevelopmentWarning(()=>!p,"Set the resolveUsers option in createClient to specify user info."),_=createBatchStore(async e=>{let t=e.flat(),n=await p?.({userIds:t});return m(),n??t.map(()=>void 0)},{delay:50}),y=e.resolveRoomsInfo,g=createDevelopmentWarning(()=>!y,"Set the resolveRoomsInfo option in createClient to specify room info."),v=createBatchStore(async e=>{let t=e.flat(),n=await y?.({roomIds:t});return g(),n??t.map(()=>void 0)},{delay:50});return Object.defineProperty({logout,enter,getRoom,leave:forceLeave,enterRoom,[N]:{notifications:{getInboxNotifications:d,getUnreadInboxNotificationsCount:c,markAllInboxNotificationsAsRead:l,markInboxNotificationAsRead:u},currentUserIdStore:a,resolveMentionSuggestions:e.resolveMentionSuggestions,cacheStore:h,usersStore:_,roomsInfoStore:v,getRoomIds:()=>Array.from(s.keys())}},N,{enumerable:!1})}var ee=class extends Error{constructor(e,t,n){super(e),this.message=e,this.status=t,this.details=n}};function checkBounds(e,t,n,i,o){if("number"!=typeof t||t<n||void 0!==i&&t>i)throw Error(void 0!==i?`${e} should be between ${o??n} and ${i}.`:`${e} should be at least ${o??n}.`);return t}function getBackgroundKeepAliveTimeout(e){if(void 0!==e)return checkBounds("backgroundKeepAliveTimeout",e,15e3)}function getThrottle(e){return checkBounds("throttle",e,16,1e3)}function getLostConnectionTimeout(e){return checkBounds("lostConnectionTimeout",e,200,3e4,1e3)}function createDevelopmentWarning(e,...t){return()=>{}}var et={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},en=RegExp(Object.keys(et).map(e=>`\\${e}`).join("|"),"g");function joinHtml(e){return e.length<=0?new ei([""],[]):new ei(["",...Array(e.length-1).fill(""),""],e)}function escapeHtml(e){return e instanceof ei?e.toString():Array.isArray(e)?joinHtml(e).toString():String(e).replace(en,e=>et[e])}var ei=class{constructor(e,t){this._strings=e,this._values=t}toString(){return this._strings.reduce((e,t,n)=>e+escapeHtml(nn(this._values[n-1]))+t)}},eo={_:"\\_","*":"\\*","#":"\\#","`":"\\`","~":"\\~","!":"\\!","|":"\\|","(":"\\(",")":"\\)","{":"\\{","}":"\\}","[":"\\[","]":"\\]"},er=RegExp(Object.keys(eo).map(e=>`\\${e}`).join("|"),"g");function joinMarkdown(e){return e.length<=0?new es([""],[]):new es(["",...Array(e.length-1).fill(""),""],e)}function escapeMarkdown(e){return e instanceof es?e.toString():Array.isArray(e)?joinMarkdown(e).toString():String(e).replace(er,e=>eo[e])}var es=class{constructor(e,t){this._strings=e,this._values=t}toString(){return this._strings.reduce((e,t,n)=>e+escapeMarkdown(nn(this._values[n-1]))+t)}};function makePoller(e){let t={state:"stopped",timeoutHandle:null,interval:null,lastScheduledAt:null,remainingInterval:null};function poll(){"running"===t.state&&schedule(t.interval),e()}function schedule(e){t={state:"running",interval:"stopped"!==t.state?t.interval:e,lastScheduledAt:performance.now(),timeoutHandle:setTimeout(poll,e),remainingInterval:null}}function scheduleRemaining(e){"paused"===t.state&&(t={state:"running",interval:t.interval,lastScheduledAt:t.lastScheduledAt,timeoutHandle:setTimeout(poll,e),remainingInterval:null})}function start(e){"running"!==t.state&&schedule(e)}function restart(e){stop(),start(e)}function stop(){"stopped"!==t.state&&(t.timeoutHandle&&clearTimeout(t.timeoutHandle),t={state:"stopped",interval:null,lastScheduledAt:null,timeoutHandle:null,remainingInterval:null})}return{start,restart,pause:function(){"running"===t.state&&(clearTimeout(t.timeoutHandle),t={state:"paused",interval:t.interval,lastScheduledAt:t.lastScheduledAt,timeoutHandle:null,remainingInterval:t.interval-(performance.now()-t.lastScheduledAt)})},resume:function(){"paused"===t.state&&scheduleRemaining(t.remainingInterval)},stop}}function shallowArray(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!Object.is(e[n],t[n]))return!1;return!0}function shallowObj(e,t){if("object"!=typeof e||null===e||"object"!=typeof t||null===t||"[object Object]"!==Object.prototype.toString.call(e)||"[object Object]"!==Object.prototype.toString.call(t))return!1;let n=Object.keys(e);return n.length===Object.keys(t).length&&n.every(n=>Object.prototype.hasOwnProperty.call(t,n)&&Object.is(e[n],t[n]))}function shallow(e,t){if(Object.is(e,t))return!0;let n=Array.isArray(e),i=Array.isArray(t);return n||i?!!n&&!!i&&shallowArray(e,t):shallowObj(e,t)}detectDupes(c,l,"esm")}}]);